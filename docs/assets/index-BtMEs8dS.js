(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function a(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=a(n);fetch(n.href,o)}})();const it='12px "Space Grotesk", system-ui, sans-serif';function he(e,t,a,s,n,o={}){const{color:d="#eaeaea",width:h=2,headSize:r=8}=o,v=Math.atan2(n-a,s-t);e.save(),e.strokeStyle=d,e.lineWidth=h,e.beginPath(),e.moveTo(t,a),e.lineTo(s,n),e.stroke(),e.beginPath(),e.moveTo(s,n),e.lineTo(s-r*Math.cos(v-Math.PI/6),n-r*Math.sin(v-Math.PI/6)),e.lineTo(s-r*Math.cos(v+Math.PI/6),n-r*Math.sin(v+Math.PI/6)),e.closePath(),e.fillStyle=d,e.fill(),e.restore()}function rt(e,t,a,s,n={}){const{color:o="#ffd700",width:d=2,focalLength:h,fMin:r=10,fMax:v=200}=n,S=s/2;let M;if(h!==void 0&&h>0){const q=Math.max(0,Math.min(1,(h-r)/(v-r)));M=s*(.25-q*.21)}else M=s*.12;e.save(),e.fillStyle="rgba(255, 215, 0, 0.08)",e.strokeStyle=o,e.lineWidth=d,e.beginPath(),e.moveTo(t,a-S),e.quadraticCurveTo(t+M,a,t,a+S),e.quadraticCurveTo(t-M,a,t,a-S),e.closePath(),e.fill(),e.stroke(),e.restore()}function je(e,t,a,s,n,o={}){const{color:d="#888888",width:h=1,dash:r=[6,6]}=o;e.save(),e.strokeStyle=d,e.lineWidth=h,e.setLineDash(r),e.beginPath(),e.moveTo(t,a),e.lineTo(s,n),e.stroke(),e.restore()}function lt(e,t,a,s,n=0){const o=s;e.save(),e.translate(t,a),e.rotate(n),e.strokeStyle="#eaeaea",e.lineWidth=1.5,e.fillStyle="rgba(234,234,234,0.05)",e.beginPath(),e.arc(0,0,o,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="rgba(234,234,234,0.12)",e.beginPath(),e.moveTo(o*.7,-o*.55),e.quadraticCurveTo(o*1.45,0,o*.7,o*.55),e.arc(0,0,o,Math.asin(.55),-Math.asin(.55),!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#eaeaea",e.beginPath(),e.arc(o*.75,0,o*.18,0,Math.PI*2),e.fill(),e.restore()}function ct(e,t,a,s,n){e.save(),e.fillStyle="rgba(179, 157, 219, 0.35)",e.strokeStyle="#b39ddb",e.lineWidth=2,e.fillRect(t,a,s,n),e.strokeRect(t,a,s,n),e.restore()}function dt(e,t,a={}){const{color:s="#4da6ff",width:n=2,dash:o,glow:d}=a;e.save(),e.strokeStyle=s,e.lineWidth=n,o&&e.setLineDash(o),d&&(e.shadowColor=s,e.shadowBlur=8),e.beginPath(),t.forEach((h,r)=>{r===0?e.moveTo(h.x,h.y):e.lineTo(h.x,h.y)}),e.stroke(),e.restore()}function ht(e,t,a,s,n,o){e.save(),e.fillStyle="rgba(77,166,255,0.06)",e.strokeStyle="rgba(77,166,255,0.5)",e.lineWidth=1.5,e.beginPath(),e.moveTo(t+8,a-s/2),e.lineTo(t+o,a-n/2),e.lineTo(t+o,a+n/2),e.lineTo(t+8,a+s/2),e.arcTo(t,a+s/2,t,a+s/2-8,8),e.lineTo(t,a-s/2+8),e.arcTo(t,a-s/2,t+8,a-s/2,8),e.closePath(),e.fill(),e.stroke(),e.restore()}function mt(e,t,a,s,n){const d=s*.12,h=s*.1,r=a+n/2;e.save(),e.fillStyle="rgba(233,69,96,0.05)",e.strokeStyle="rgba(233,69,96,0.4)",e.lineWidth=1.5,e.beginPath(),e.moveTo(t+10,a),e.lineTo(t+s-10,a),e.arcTo(t+s,a,t+s,a+10,10),e.quadraticCurveTo(t+s-h,r,t+s,a+n-10),e.arcTo(t+s,a+n,t+s-10,a+n,10),e.lineTo(t+10,a+n),e.arcTo(t,a+n,t,a+n-10,10),e.quadraticCurveTo(t-d,r,t,a+10),e.arcTo(t,a,t+10,a,10),e.closePath(),e.fill(),e.stroke(),e.restore()}function x(e,t,a,s,n={}){const{color:o="#eaeaea",background:d="rgba(0, 0, 0, 0.45)",padding:h=4,font:r=it}=n;e.save(),e.font=r;const S=e.measureText(t).width+h*2,M=16+h;e.fillStyle=d,e.fillRect(a-S/2,s-M/2,S,M),e.fillStyle=o,e.textAlign="center",e.textBaseline="middle",e.fillText(t,a,s+1),e.restore()}const u={accent:"#e94560",text:"#eaeaea",rayLeft:"#4da6ff",rayGreen:"#4caf50",rayYellow:"#ffc107",virtualImage:"#a855f7",lens:"#ffd700",axis:"#555555"};function ut(e,t){return 1/(1/e-1/t)}function ft(e,t){return-e/t}function yt(e){return!Number.isFinite(e)||Math.abs(e)>1e6?"infinity":e>0?"real":"virtual"}class gt{container;canvas;ctx;controlsEl;readoutsEl;width=0;height=0;resizeObserver;rafId=null;resizeTimer=null;constructor(t){this.container=t;const a=t.querySelector("[data-canvas]"),s=t.querySelector("[data-controls]"),n=t.querySelector("[data-readouts]");if(!a||!s||!n)throw new Error("Panel container missing required elements");this.controlsEl=s,this.readoutsEl=n,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("aria-label","Optics visualization"),a.appendChild(this.canvas);const o=this.canvas.getContext("2d");if(!o)throw new Error("Canvas context unavailable");this.ctx=o,this.resizeObserver=new ResizeObserver(()=>this.scheduleResize()),this.resizeObserver.observe(a),this.resize()}scheduleResize(){this.resizeTimer!==null&&window.clearTimeout(this.resizeTimer),this.resizeTimer=window.setTimeout(()=>{this.resizeTimer=null,this.resize()},120)}resize(){const t=this.canvas.parentElement;if(!t)return;const a=t.getBoundingClientRect(),s=Math.max(0,Math.floor(a.width)),n=Math.max(0,Math.floor(a.height));if(s===this.width&&n===this.height)return;const o=window.devicePixelRatio||1;this.canvas.width=Math.floor(s*o),this.canvas.height=Math.floor(n*o),this.width=s,this.height=n,this.ctx.setTransform(o,0,0,o,0,0),this.requestDraw()}requestDraw(){this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.render()})}addSlider(t){const a=document.createElement("div");a.className="control-row";const s=document.createElement("label");s.htmlFor=t.id,s.textContent=t.label;const n=document.createElement("div");n.className="value";const o=document.createElement("input");o.id=t.id,o.type="range",o.min=String(t.min),o.max=String(t.max),o.step=String(t.step),o.value=String(t.value);const d=h=>{const r=Number(h);n.textContent=`${r}${t.unit??""}`,t.onChange?.(r),this.requestDraw()};return o.addEventListener("input",()=>d(o.value)),d(o.value),a.appendChild(s),a.appendChild(o),a.appendChild(n),this.controlsEl.appendChild(a),o}addReadout(t){const a=document.createElement("div");a.className="readout",a.dataset.readout=t.id;const s=document.createElement("span");s.textContent=t.label;const n=document.createElement("span");return n.textContent=`--${t.unit??""}`,a.appendChild(s),a.appendChild(n),this.readoutsEl.appendChild(a),n}setReadout(t,a){const s=this.readoutsEl.querySelector(`[data-readout="${t}"] span:last-child`);s&&(s.textContent=a)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}render(){this.clear();const{width:t,height:a}=this;this.ctx.fillStyle="#101424",this.ctx.fillRect(0,0,t,a),this.ctx.fillStyle="#eaeaea",this.ctx.font='14px "Space Grotesk", system-ui, sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Panel rendering...",t/2,a/2)}dispose(){this.resizeObserver.disconnect(),this.resizeTimer!==null&&(window.clearTimeout(this.resizeTimer),this.resizeTimer=null)}}class pt{placed=[];place(t,a,s,n){const o={x:t-s/2,y:a-n/2};let d=o.x,h=o.y;const r=[[0,0],[0,-n-2],[0,n+2],[-s-4,0],[s+4,0],[0,-n*2-4],[0,n*2+4],[-s-4,-n-2],[s+4,-n-2]];for(const[v,S]of r){const M=o.x+v,q=o.y+S;let T=!1;for(const p of this.placed)if(M<p.x+p.w&&M+s>p.x&&q<p.y+p.h&&q+n>p.y){T=!0;break}if(!T){d=M,h=q;break}}return this.placed.push({x:d,y:h,w:s,h:n}),{x:d+s/2,y:h+n/2}}}class bt extends gt{fInput;doInput;constructor(t){super(t),this.fInput=this.addSlider({id:"thin-lens-f",label:"Focal Length (mm)",min:10,max:200,step:1,value:40,unit:"mm"}),this.doInput=this.addSlider({id:"thin-lens-do",label:"Lens-to-Display Distance (mm)",min:5,max:500,step:1,value:100,unit:"mm"}),this.addReadout({id:"thin-lens-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"thin-lens-m",label:"Magnification",unit:"x"}),this.addReadout({id:"thin-lens-regime",label:"Regime",unit:""})}render(){this.clear();const t=this.ctx;t.fillStyle="#111122",t.fillRect(0,0,this.width,this.height);const a=Number(this.fInput.value),s=Number(this.doInput.value),n=ut(a,s),o=Math.max(3,a*.05),d=Math.abs(s-a)<o,h=d?Number.POSITIVE_INFINITY:n,r=d?"infinity":yt(h),v=ft(n,s),S=r==="infinity"?"∞":n.toFixed(0),M=Number.isFinite(v)?v.toFixed(2):"--";this.setReadout("thin-lens-di",S),this.setReadout("thin-lens-m",M);const q=r==="infinity"?"At focal point":s<a?"HMD (virtual image)":"Projector (real image)";this.setReadout("thin-lens-regime",q);const T=40,p=50,ae=s<a?Math.max(80,a*.6):60,l={x:-s,y:T},w={x:0,y:0},ye=T*5;let Y=l.y;if(r!=="infinity"){const i=-a-l.x;if(Math.abs(i)>.01){const c=(0-l.y)/i;Y=l.y+c*(0-l.x),Y=Math.max(-ye,Math.min(ye,Y))}}const F=[];r==="infinity"?(F.push(l.y),F.push(0),F.push(l.y)):(F.push(l.y),F.push(w.y),F.push(Y));const _e=Math.max(...F.map(Math.abs)),se=Math.min(Math.max(_e+12,40),80),ge=se*2,pe=6,A=Math.max(-pe,Math.min(pe,v)),be=T*A,$e=Math.max(s*5,a*5,500),Ve=Math.max(s*2.5,a*2,350),$=r==="virtual"&&Math.abs(n)>Ve,V=r==="real"&&n>$e,Je=$||V?Math.sign(A)*Math.min(Math.abs(A),3):A,Ke=T*Je,Ue=-s-30;let J=ae+30,K=Ue;if(r!=="infinity"){const i=n;r==="real"&&i>0&&!V?J=Math.max(J,i+30):r==="virtual"&&i<0&&!$&&(K=Math.min(K,i-30))}K=Math.min(K,-a-10),J=Math.max(J,a+10);const Qe=Math.abs(Ke)+10,ve=Math.max(p+20,se+10,Qe,80);let I=K,E=J,H=-ve,C=ve;const Me=E-I,Te=C-H,xe=.08,we=.12;I-=Me*xe,E+=Me*xe,H-=Te*we,C+=Te*we;const Se=300,Pe=180,Le=E-I,ke=C-H;if(Le<Se){const i=(Se-Le)/2;I-=i,E+=i}if(ke<Pe){const i=(Pe-ke)/2;H-=i,C+=i}const me=this.width/this.height;if((E-I)/(C-H)>me){const c=((E-I)/me-(C-H))/2;H-=c,C+=c}else{const c=((C-H)*me-(E-I))/2;I-=c,E+=c}const k=I,W=E,ne=H,U=C,oe=24,Ze=(this.width-oe*2)/(W-k),Q=(this.height-oe*2)/(U-ne),m=(i,c)=>({x:oe+(i-k)*Ze,y:this.height-oe-(c-ne)*Q}),z=W,D=(i,c,y)=>{dt(t,i.map(f=>m(f.x,f.y)),{color:y??u.rayLeft,dash:c})},O=new pt,X=(i,c)=>{t.save(),t.font=c??'12px "Space Grotesk", system-ui, sans-serif';const y=t.measureText(i);return t.restore(),{w:y.width+8,h:20}},Re=m(k,0),Ie=m(W,0);je(t,Re.x,Re.y,Ie.x,Ie.y,{color:u.axis,dash:[6,6]});const ie=m(k+(W-k)*.05,U-(U-ne)*.08),ue=m(W-(W-k)*.05,U-(U-ne)*.08);he(t,ie.x,ie.y,ue.x,ue.y,{color:"rgba(255,255,255,0.18)",width:1.5,headSize:8}),x(t,"light direction →",(ie.x+ue.x)/2,ie.y-10,{color:"rgba(255,255,255,0.35)",background:"transparent"});const R=m(0,0);if(s>a&&!d){const i=m(-s-20,0),y=m(0,0).x-i.x,f=p*2*Q+30,g=ge*Q+10;ht(t,i.x,R.y,f,g,y)}else if(s<a){const i=-s-15,c=ae+20,y=Math.max(p,se)+10,f=m(i,y),b=m(c,-y);let g=b.x-f.x,P=b.y-f.y;const L=120,N=80;let _=f.x,te=f.y;if(g<L){const fe=(L-g)/2;_-=fe,g=L}if(P<N){const fe=(N-P)/2;te-=fe,P=N}mt(t,_,te,g,P)}t.save(),t.strokeStyle="rgba(255, 215, 0, 0.15)",t.lineWidth=1,t.setLineDash([6,6]),t.beginPath(),t.moveTo(R.x,0),t.lineTo(R.x,this.height),t.stroke(),t.restore();const et=ge*Q,tt=this.height*.8,at=Math.min(et,tt);rt(t,R.x,R.y,at,{color:u.lens,focalLength:a,fMin:Number(this.fInput.min),fMax:Number(this.fInput.max)});const G=m(-a,0),j=m(a,0),B=10,re='italic 11px "Space Grotesk", system-ui, sans-serif';t.save(),t.strokeStyle=u.lens,t.lineWidth=2,t.beginPath(),t.moveTo(G.x,G.y-B),t.lineTo(G.x,G.y+B),t.stroke(),t.beginPath(),t.moveTo(j.x,j.y-B),t.lineTo(j.x,j.y+B),t.stroke(),t.restore();const Ee=X("f",re),He=O.place(G.x,G.y+B+12,Ee.w,Ee.h);x(t,"f",He.x,He.y,{color:u.lens,font:re,background:"rgba(0,0,0,0.5)"});const Ce=X("f′",re),We=O.place(j.x,j.y+B+12,Ce.w,Ce.h);x(t,"f′",We.x,We.y,{color:u.lens,font:re,background:"rgba(0,0,0,0.5)"});const Z=m(-s,p),st=m(-s,-p),ze=6;ct(t,Z.x-ze/2,Z.y,ze,st.y-Z.y);const De=X("Display"),Ye=O.place(Z.x,Z.y-16,De.w,De.h);x(t,"Display",Ye.x,Ye.y,{background:"rgba(179, 157, 219, 0.25)"});const Oe=m(-s,0),Xe=m(-s,T);he(t,Oe.x,Oe.y,Xe.x,Xe.y,{color:u.accent,width:2.5});const le=(W-k)*.05;let ee=n,ce=be;if(r!=="infinity"){if(ee=$?k+le:V?W-le:Math.max(k+le,Math.min(W-le,n)),$){const g=-T/a,P=-T/s,L=T+g*ee,N=P*ee,_=(L+N)/2,te=T*4;ce=Math.max(-te,Math.min(te,_))}else V?ce=T*Math.sign(A)*Math.min(Math.abs(A),3):ce=be;const i=m(ee,0),c=m(ee,ce);if(r==="virtual"){if(je(t,i.x,i.y,c.x,c.y,{color:u.virtualImage,dash:[6,6],width:2}),he(t,i.x,i.y,c.x,c.y,{color:u.virtualImage,width:2,headSize:6}),$){const g=i.x-8;x(t,"← "+n.toFixed(0)+"mm",g,i.y-18,{color:u.virtualImage,background:"rgba(168, 85, 247, 0.3)",font:'10px "Space Grotesk", system-ui, sans-serif'})}}else if(he(t,i.x,i.y,c.x,c.y,{color:u.rayGreen,width:2.5}),V){const g=i.x+8;x(t,"→ "+n.toFixed(0)+"mm",g,i.y-18,{color:u.rayGreen,background:"rgba(76, 175, 80, 0.3)",font:'10px "Space Grotesk", system-ui, sans-serif'})}const y=r==="virtual"?"Virtual Image":"Real Image",f=X(y),b=O.place(c.x,c.y-16,f.w,f.h);x(t,y,b.x,b.y,{background:r==="virtual"?"rgba(168, 85, 247, 0.25)":"rgba(76, 175, 80, 0.2)"})}else x(t,"Image at ∞",R.x+90,R.y-40,{background:"rgba(255, 255, 255, 0.08)"});if(r==="infinity")D([{x:l.x,y:l.y},{x:w.x,y:l.y},{x:z,y:l.y}],void 0,u.rayLeft),D([{x:l.x,y:l.y},{x:w.x,y:0},{x:z,y:l.y/s*z*-1}],void 0,u.rayYellow),D([{x:l.x,y:l.y},{x:0,y:l.y},{x:z,y:l.y}],void 0,u.rayGreen);else{const i=-40/a,c={x:z,y:l.y+i*z};D([{x:l.x,y:l.y},{x:0,y:l.y},{x:c.x,y:c.y}],void 0,u.rayLeft);const y=(w.y-l.y)/(w.x-l.x),f={x:z,y:w.y+y*z};D([{x:l.x,y:l.y},{x:w.x,y:w.y},{x:f.x,y:f.y}],void 0,u.rayYellow);const b={x:z,y:Y};if(D([{x:l.x,y:l.y},{x:0,y:Y},{x:b.x,y:b.y}],void 0,u.rayGreen),r==="virtual"){const g=-40/a,P=(w.y-l.y)/(w.x-l.x),L=k,N=l.y+g*L;D([{x:0,y:l.y},{x:L,y:N}],[6,6],u.virtualImage);const _=w.y+P*L;D([{x:0,y:w.y},{x:L,y:_}],[6,6],u.virtualImage),D([{x:0,y:Y},{x:L,y:Y}],[6,6],u.virtualImage)}}const de=m(ae,0),nt=s<a?Math.PI:0;lt(t,de.x,de.y,14,nt);const qe=X("Eye"),Fe=O.place(de.x,de.y-26,qe.w,qe.h);if(x(t,"Eye",Fe.x,Fe.y,{color:u.text,background:"rgba(255,255,255,0.08)"}),s>a&&!d){const i=m(-s-20,0),y=m(0,0).x-i.x,f=X("PROJECTOR"),b=O.place(i.x+y/2,R.y-p*Q-28,f.w,f.h);x(t,"PROJECTOR",b.x,b.y,{color:"#4da6ff",background:"rgba(77,166,255,0.18)"})}else if(s<a){const i=-s-15,c=ae+20,y=Math.max(p,se)+10,f=m(i,y),b=m(c,-y),g=X("HMD"),P=O.place((f.x+b.x)/2,f.y-12,g.w,g.h);x(t,"HMD",P.x,P.y,{color:"#e94560",background:"rgba(233,69,96,0.18)"})}const Ne=r==="infinity"?"d_o = f → image at ∞":s<a?"HMD regime: d_o < f → virtual image":"Projector regime: d_o > f → real image",Ae=X(Ne),Ge=O.place(R.x,R.y+70,Ae.w,Ae.h);x(t,Ne,Ge.x,Ge.y,{background:s<a?"rgba(233, 69, 96, 0.2)":s>a?"rgba(77,166,255,0.15)":"rgba(255, 255, 255, 0.08)"});const ot=`1/f = 1/d_o + 1/d_i  →  1/${a} = 1/${s} + 1/${S}`;x(t,ot,this.width/2,this.height-16,{color:"rgba(255,255,255,0.6)",background:"rgba(0,0,0,0.5)",font:'11px "Space Grotesk", system-ui, sans-serif'})}}const Be=document.querySelector('[data-panel="thin-lens"]');Be&&new bt(Be);
