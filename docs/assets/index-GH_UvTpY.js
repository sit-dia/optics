(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function i(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=i(a);fetch(a.href,o)}})();const Mt='12px "Space Grotesk", system-ui, sans-serif';function Y(e,t,i,s,a,o={}){const{color:n="#eaeaea",width:l=2,headSize:h=8}=o,m=Math.atan2(a-i,s-t);e.save(),e.strokeStyle=n,e.lineWidth=l,e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.stroke(),e.beginPath(),e.moveTo(s,a),e.lineTo(s-h*Math.cos(m-Math.PI/6),a-h*Math.sin(m-Math.PI/6)),e.lineTo(s-h*Math.cos(m+Math.PI/6),a-h*Math.sin(m+Math.PI/6)),e.closePath(),e.fillStyle=n,e.fill(),e.restore()}function tt(e,t,i,s,a={}){const{color:o="#ffd700",width:n=2}=a;e.save(),e.strokeStyle=o,e.lineWidth=n,e.beginPath(),e.moveTo(t,i-s/2),e.lineTo(t,i+s/2),e.stroke(),Y(e,t,i-s/2,t,i-s/2-12,{color:o,width:n,headSize:6}),Y(e,t,i+s/2,t,i+s/2+12,{color:o,width:n,headSize:6}),e.restore()}function G(e,t,i,s,a,o={}){const{color:n="#888888",width:l=1,dash:h=[6,6]}=o;e.save(),e.strokeStyle=n,e.lineWidth=l,e.setLineDash(h),e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.stroke(),e.restore()}function U(e,t,i,s,a=0){e.save(),e.translate(t,i),e.rotate(a),e.strokeStyle="#eaeaea",e.lineWidth=2,e.beginPath(),e.arc(0,0,s,0,Math.PI*2),e.stroke(),e.fillStyle="#11121d",e.beginPath(),e.arc(s*.2,0,s*.35,0,Math.PI*2),e.fill(),e.restore()}function st(e,t,i,s,a){e.save(),e.fillStyle="rgba(179, 157, 219, 0.35)",e.strokeStyle="#b39ddb",e.lineWidth=2,e.fillRect(t,i,s,a),e.strokeRect(t,i,s,a),e.restore()}function pt(e,t,i,s,a,o,n=12){e.save(),e.strokeStyle="#888888",e.lineWidth=1;const l=s-t,h=a-i,m=Math.hypot(l,h);if(m===0)return;const p=-h/m,b=l/m,k=p*n,E=b*n;e.beginPath(),e.moveTo(t+k,i+E),e.lineTo(s+k,a+E),e.stroke(),e.beginPath(),e.moveTo(t+k,i+E),e.lineTo(t+k+p*6,i+E+b*6),e.stroke(),e.beginPath(),e.moveTo(s+k,a+E),e.lineTo(s+k+p*6,a+E+b*6),e.stroke(),M(e,o,(t+s)/2+k,(i+a)/2+E),e.restore()}function at(e,t,i={}){const{color:s="#4da6ff",width:a=2,dash:o,glow:n}=i;e.save(),e.strokeStyle=s,e.lineWidth=a,o&&e.setLineDash(o),n&&(e.shadowColor=s,e.shadowBlur=8),e.beginPath(),t.forEach((l,h)=>{h===0?e.moveTo(l.x,l.y):e.lineTo(l.x,l.y)}),e.stroke(),e.restore()}function ft(e,t,i,s){const{width:a,height:o}=e.canvas;e.save(),e.strokeStyle="#444444",e.lineWidth=1;for(let n=0;n<=t;n+=1){const l=n/t*o;e.beginPath();for(let h=0;h<=i;h+=1){const m=h/i*a,p=s?s(m,l):{x:m,y:l};h===0?e.moveTo(p.x,p.y):e.lineTo(p.x,p.y)}e.stroke()}for(let n=0;n<=i;n+=1){const l=n/i*a;e.beginPath();for(let h=0;h<=t;h+=1){const m=h/t*o,p=s?s(l,m):{x:l,y:m};h===0?e.moveTo(p.x,p.y):e.lineTo(p.x,p.y)}e.stroke()}e.restore()}function M(e,t,i,s,a={}){const{color:o="#eaeaea",background:n="rgba(0, 0, 0, 0.45)",padding:l=4,font:h=Mt}=a;e.save(),e.font=h;const p=e.measureText(t).width+l*2,b=16+l;e.fillStyle=n,e.fillRect(i-p/2,s-b/2,p,b),e.fillStyle=o,e.textAlign="center",e.textBaseline="middle",e.fillText(t,i,s+1),e.restore()}const Z={f:.043,distLens2Display:.042,eyeRelief:.018,ipd:.065,displayWidth:.12096,displayHeight:.068},Q={k1:.34,k2:.55},g={accent:"#e94560",text:"#eaeaea",rayLeft:"#4da6ff",rayRight:"#ff6b6b",rayGreen:"#4caf50",rayYellow:"#ffc107",virtualImage:"#a855f7",overlap:"rgba(128, 0, 255, 0.15)",lens:"#ffd700",axis:"#555555"},kt=.3,St=.5;function vt(e,t){return 1/(1/e-1/t)}function Ft(e,t){return-e/t}function bt(e){return!Number.isFinite(e)||Math.abs(e)>1e6?"infinity":e>0?"real":"virtual"}const et=180/Math.PI;function wt(e){const{f:t,distLens2Display:i,eyeRelief:s,ipd:a,displayWidth:o,displayHeight:n}=e,l=t/(t-i),h=Math.abs(1/(1/t-1/i)),m=h+s,p=s+i,b=n*l,k=2*Math.atan(b/2/m)*et,E=Math.atan(l*a/2/m)*et,N=Math.atan(l*(o-a)/2/m)*et,y=E+N,A=s+i,v=A*b/(2*m),S=-v,C=l*a/2,L=l*(o-a)/2,d=p*C/m,F=-(p*L)/m,c=p*L/m,u=-(p*C)/m;return{distEye2Display:p,magnification:l,imgHeight:b,distLens2Img:h,distEye2Img:m,near:A,fovVertical:k,fovHNasal:E,fovHTemporal:N,fovHorizontal:y,top:v,bottom:S,imgWidthNasal:C,imgWidthTemporal:L,leftForLeftEye:F,rightForLeftEye:d,leftForRightEye:u,rightForRightEye:c}}function it(e,t,i,s,a,o){const n=e-i,l=t-s,h=n*n+l*l,m=1+a*h+o*h*h;return{x:i+n*m,y:s+l*m}}function xt(e){return 1/e}function Lt(e,t){return Math.abs(xt(e)-xt(t))}class _{container;canvas;ctx;controlsEl;readoutsEl;width=0;height=0;resizeObserver;rafId=null;resizeTimer=null;constructor(t){this.container=t;const i=t.querySelector("[data-canvas]"),s=t.querySelector("[data-controls]"),a=t.querySelector("[data-readouts]");if(!i||!s||!a)throw new Error("Panel container missing required elements");this.controlsEl=s,this.readoutsEl=a,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("aria-label","Optics visualization"),i.appendChild(this.canvas);const o=this.canvas.getContext("2d");if(!o)throw new Error("Canvas context unavailable");this.ctx=o,this.resizeObserver=new ResizeObserver(()=>this.scheduleResize()),this.resizeObserver.observe(i),this.resize()}scheduleResize(){this.resizeTimer!==null&&window.clearTimeout(this.resizeTimer),this.resizeTimer=window.setTimeout(()=>{this.resizeTimer=null,this.resize()},120)}resize(){const t=this.canvas.parentElement;if(!t)return;const i=window.getComputedStyle(t),s=Number.parseFloat(i.paddingLeft)+Number.parseFloat(i.paddingRight),a=Number.parseFloat(i.paddingTop)+Number.parseFloat(i.paddingBottom),o=Math.max(0,t.clientWidth-s),n=Math.max(0,t.clientHeight-a);if(o===this.width&&n===this.height)return;const l=window.devicePixelRatio||1;this.canvas.width=Math.floor(o*l),this.canvas.height=Math.floor(n*l),this.canvas.style.width=`${o}px`,this.canvas.style.height=`${n}px`,this.width=o,this.height=n,this.ctx.setTransform(l,0,0,l,0,0),this.requestDraw()}requestDraw(){this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.render()})}addSlider(t){const i=document.createElement("div");i.className="control-row";const s=document.createElement("label");s.htmlFor=t.id,s.textContent=t.label;const a=document.createElement("div");a.className="value";const o=document.createElement("input");o.id=t.id,o.type="range",o.min=String(t.min),o.max=String(t.max),o.step=String(t.step),o.value=String(t.value);const n=l=>{const h=Number(l);a.textContent=`${h}${t.unit??""}`,t.onChange?.(h),this.requestDraw()};return o.addEventListener("input",()=>n(o.value)),n(o.value),i.appendChild(s),i.appendChild(o),i.appendChild(a),this.controlsEl.appendChild(i),o}addReadout(t){const i=document.createElement("div");i.className="readout",i.dataset.readout=t.id;const s=document.createElement("span");s.textContent=t.label;const a=document.createElement("span");return a.textContent=`--${t.unit??""}`,i.appendChild(s),i.appendChild(a),this.readoutsEl.appendChild(i),a}setReadout(t,i){const s=this.readoutsEl.querySelector(`[data-readout="${t}"] span:last-child`);s&&(s.textContent=i)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}render(){this.clear();const{width:t,height:i}=this;this.ctx.fillStyle="#101424",this.ctx.fillRect(0,0,t,i),this.ctx.fillStyle="#eaeaea",this.ctx.font='14px "Space Grotesk", system-ui, sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Panel rendering...",t/2,i/2)}dispose(){this.resizeObserver.disconnect(),this.resizeTimer!==null&&(window.clearTimeout(this.resizeTimer),this.resizeTimer=null)}}class Pt extends _{k1Input;k2Input;gridInput;preToggle;constructor(t){super(t),this.k1Input=this.addSlider({id:"distortion-k1",label:"k1",min:-1,max:1,step:.01,value:Q.k1}),this.k2Input=this.addSlider({id:"distortion-k2",label:"k2",min:-1,max:1,step:.01,value:Q.k2}),this.gridInput=this.addSlider({id:"distortion-grid",label:"Grid Density",min:4,max:20,step:1,value:8});const i=document.createElement("div");i.className="control-row";const s=document.createElement("label");s.htmlFor="distortion-pre-toggle",s.textContent="Pre-correction",this.preToggle=document.createElement("input"),this.preToggle.id="distortion-pre-toggle",this.preToggle.name="distortion-pre-toggle",this.preToggle.type="checkbox",this.preToggle.checked=!1,this.preToggle.addEventListener("change",()=>this.requestDraw()),i.appendChild(s),i.appendChild(this.preToggle),this.controlsEl.appendChild(i)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.k1Input.value),s=Number(this.k2Input.value),a=Number(this.gridInput.value),o=16,n=18,l=(this.height-o*2-n*2)/3,h=this.width-o*2,m=[{x:o,y:o,width:h,height:l},{x:o,y:o+l+n,width:h,height:l},{x:o,y:o+(l+n)*2,width:h,height:l}],p=(c,u,D,O=0,H=0)=>{t.save(),t.beginPath(),t.rect(c.x,c.y,c.width,c.height),t.clip(),t.translate(c.x,c.y),t.scale(c.width/t.canvas.width,c.height/t.canvas.height);const f=t.canvas.width,r=t.canvas.height,w=f/2,x=r/2,T=Math.min(f,r)/2;ft(t,u,D,O!==0||H!==0?(R,I)=>{const z=(R-w)/T,W=(I-x)/T,V=it(z,W,0,0,O,H);return{x:w+V.x*T,y:x+V.y*T}}:void 0),t.restore()},b=m[0],k=m[1],E=m[2],N=(b.width-n)/2,y={x:b.x,y:b.y,width:N,height:b.height},A={x:b.x+N+n,y:b.y,width:N,height:b.height};p(y,a,a,Q.k1,Q.k2),p(A,a,a,-.34,-.55),M(t,"Barrel distortion",y.x+90,y.y+18,{background:"rgba(233, 69, 96, 0.25)"}),M(t,"Pincushion distortion",A.x+100,A.y+18,{background:"rgba(15, 52, 96, 0.4)"});const v=12,S=4,C=(k.width-v*(S-1))/S,L=k.height,d=Array.from({length:S},(c,u)=>({x:k.x+u*(C+v),y:k.y,width:C,height:L}));p(d[0],8,8),M(t,"Original",d[0].x+40,d[0].y+18,{background:"rgba(255, 255, 255, 0.08)"}),p(d[1],8,8,-i,-s),M(t,"Pre-distort",d[1].x+46,d[1].y+18,{background:"rgba(15, 52, 96, 0.4)"}),p(d[2],8,8,i,s),M(t,"Lens barrel",d[2].x+46,d[2].y+18,{background:"rgba(233, 69, 96, 0.25)"}),p(d[3],8,8,0,0),M(t,"Straight",d[3].x+42,d[3].y+18,{background:"rgba(76, 175, 80, 0.2)"});for(let c=0;c<d.length-1;c+=1){const u=d[c],D=d[c+1];Y(t,u.x+u.width+4,u.y+u.height/2,D.x-4,D.y+D.height/2,{color:"#eaeaea",width:1.5,headSize:6})}const F=this.preToggle.checked?"Pre-correction ON → canceling barrel":"Interactive distortion playground";if(M(t,F,E.x+120,E.y+18,{background:"rgba(255, 255, 255, 0.08)"}),this.preToggle.checked){const c=(u,D)=>{const O=t.canvas.width/2,H=t.canvas.height/2,f=Math.min(t.canvas.width,t.canvas.height)/2,r=(u-O)/f,w=(D-H)/f,x=it(r,w,0,0,-i,-s),T=it(x.x,x.y,0,0,i,s);return{x:O+T.x*f,y:H+T.y*f}};t.save(),t.beginPath(),t.rect(E.x,E.y,E.width,E.height),t.clip(),t.translate(E.x,E.y),t.scale(E.width/t.canvas.width,E.height/t.canvas.height),ft(t,a,a,c),t.restore()}else p(E,a,a,i,s)}}class Nt extends _{ipdInput;eyeReliefInput;fInput;doInput;fovToggle;warningEl;constructor(t){super(t),this.ipdInput=this.addSlider({id:"params-ipd",label:"IPD (mm)",min:52,max:78,step:1,value:63,unit:"mm"}),this.eyeReliefInput=this.addSlider({id:"params-eye-relief",label:"Eye Relief (mm)",min:8,max:25,step:1,value:18,unit:"mm"}),this.fInput=this.addSlider({id:"params-f",label:"Focal Length (mm)",min:30,max:60,step:1,value:43,unit:"mm"}),this.doInput=this.addSlider({id:"params-do",label:"Lens to Display (mm)",min:30,max:55,step:1,value:42,unit:"mm"});const i=document.createElement("div");i.className="control-row";const s=document.createElement("label");s.htmlFor="params-fov-toggle",s.textContent="Show FOV breakdown",this.fovToggle=document.createElement("input"),this.fovToggle.id="params-fov-toggle",this.fovToggle.name="params-fov-toggle",this.fovToggle.type="checkbox",this.fovToggle.checked=!0,this.fovToggle.addEventListener("change",()=>this.requestDraw()),i.appendChild(s),i.appendChild(this.fovToggle),this.controlsEl.appendChild(i),this.addReadout({id:"params-mag",label:"Magnification",unit:"x"}),this.addReadout({id:"params-img",label:"Virtual Image Dist",unit:"mm"}),this.addReadout({id:"params-eye-img",label:"Eye-to-Image",unit:"mm"}),this.addReadout({id:"params-fov-v",label:"FOV Vertical",unit:"deg"}),this.addReadout({id:"params-fov-nasal",label:"FOV H-Nasal",unit:"deg"}),this.addReadout({id:"params-fov-temporal",label:"FOV H-Temporal",unit:"deg"}),this.addReadout({id:"params-fov",label:"FOV H-Total",unit:"deg"}),this.addReadout({id:"params-near",label:"Near Plane",unit:"mm"}),this.warningEl=document.createElement("div"),this.warningEl.className="callout",this.warningEl.textContent="Extreme IPD values can reduce comfort.",this.controlsEl.appendChild(this.warningEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.ipdInput.value),s=Number(this.eyeReliefInput.value),a=Number(this.fInput.value),o=Number(this.doInput.value),n=wt({...Z,ipd:i/1e3,eyeRelief:s/1e3,f:a/1e3,distLens2Display:o/1e3});this.setReadout("params-mag",n.magnification.toFixed(2)),this.setReadout("params-img",(n.distLens2Img*1e3).toFixed(0)),this.setReadout("params-eye-img",(n.distEye2Img*1e3).toFixed(0)),this.setReadout("params-fov-v",n.fovVertical.toFixed(1)),this.setReadout("params-fov-nasal",n.fovHNasal.toFixed(1)),this.setReadout("params-fov-temporal",n.fovHTemporal.toFixed(1)),this.setReadout("params-fov",n.fovHorizontal.toFixed(1)),this.setReadout("params-near",(n.near*1e3).toFixed(0));const l=i<56||i>72;this.warningEl.style.display=l?"block":"none";const h=20,m=-120,p=120,b=-140,k=80,E=(this.width-h*2)/(p-m),N=(this.height-h*2)/(k-b),y=(V,j)=>({x:h+(V-m)*E,y:this.height-h-(j-b)*N}),A=(V,j,$)=>{at(t,V.map(q=>y(q.x,q.y)),{color:j,dash:$})},v=Z.displayWidth*1e3,S=14,C=-o,L=s,d=0,F=y(-v/2,C+S/2);st(t,F.x,F.y,v*E,S*N),M(t,"Display",F.x+42,F.y-12,{background:"rgba(179, 157, 219, 0.2)"});const c=-i/2,u=i/2,D=y(c,L),O=y(u,L);U(t,D.x,D.y,12,0),U(t,O.x,O.y,12,0);const H=y(c,d),f=y(u,d);tt(t,H.x,H.y,32,{color:g.lens}),tt(t,f.x,f.y,32,{color:g.lens});const r=s+n.distLens2Img*1e3,w=n.magnification*Z.displayWidth*1e3,x=y(-w/2,r+8);G(t,x.x,x.y,x.x+w*E,x.y,{color:g.virtualImage,dash:[6,6],width:1.5}),M(t,"Virtual image",x.x+50,x.y-14,{background:"rgba(168, 85, 247, 0.25)"});const T=n.imgWidthNasal*1e3,P=n.imgWidthTemporal*1e3,R={x:c+T,y:r},I={x:c-P,y:r},z={x:u-T,y:r},W={x:u+P,y:r};if(A([{x:c,y:L},{x:R.x,y:R.y}],g.rayLeft),A([{x:c,y:L},{x:I.x,y:I.y}],g.rayLeft),A([{x:u,y:L},{x:z.x,y:z.y}],g.rayRight),A([{x:u,y:L},{x:W.x,y:W.y}],g.rayRight),this.fovToggle.checked){if(R.x<z.x){const V=y(c,L),j=y(u,L),$=y(R.x,R.y),q=y(z.x,z.y);t.save(),t.fillStyle=g.overlap,t.beginPath(),t.moveTo(V.x,V.y),t.lineTo(j.x,j.y),t.lineTo(q.x,q.y),t.lineTo($.x,$.y),t.closePath(),t.fill(),t.restore()}M(t,"Nasal",y(R.x,R.y).x+12,y(R.x,R.y).y-12,{background:"rgba(255, 255, 255, 0.08)"}),M(t,"Temporal",y(I.x,I.y).x-12,y(I.x,I.y).y-12,{background:"rgba(255, 255, 255, 0.08)"})}pt(t,y(c,L).x,y(c,L).y+22,y(u,L).x,y(u,L).y+22,`IPD ${i.toFixed(0)}mm`,10),pt(t,y(u+18,d).x,y(u+18,d).y,y(u+18,L).x,y(u+18,L).y,`Eye relief ${s.toFixed(0)}mm`,8),M(t,"Top-down HMD cross-section",y(0,k-10).x,28,{background:"rgba(15, 52, 96, 0.4)"})}}class Dt extends _{fInput;doInput;calloutEl;constructor(t){super(t),this.fInput=this.addSlider({id:"light-path-f",label:"Focal Length (mm)",min:20,max:100,step:1,value:43,unit:"mm"}),this.doInput=this.addSlider({id:"light-path-do",label:"Object Distance (mm)",min:10,max:120,step:1,value:42,unit:"mm"}),this.addReadout({id:"light-path-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"light-path-regime",label:"Regime",unit:""}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.fInput.value),s=Number(this.doInput.value),a=vt(i,s),o=Math.abs(s-i)<1,n=o?Number.POSITIVE_INFINITY:a,l=o?"infinity":bt(n),h=l==="infinity"?"∞":a.toFixed(0);this.setReadout("light-path-di",h),this.setReadout("light-path-regime",s<i?"HMD (virtual image)":"Projection (real image)"),this.calloutEl.textContent=s<i?"Display inside focal length → virtual, magnified image (HMD regime).":"Object beyond focal length → real inverted image (projection regime).";const m=18,p=24,b=(this.height-m*2-p)/2,k=this.width-m*2,E=[{x:m,y:m,width:k,height:b},{x:m,y:m+b+p,width:k,height:b}],N=(y,A)=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(y.x,y.y,y.width,y.height);const v=-130,S=170,C=-80,L=80,d=y.width/(S-v),F=y.height/(L-C),c=(f,r)=>({x:y.x+(f-v)*d,y:y.y+y.height-(r-C)*F}),u=(f,r,w)=>{at(t,f.map(x=>c(x.x,x.y)),{color:w??g.rayLeft,dash:r})},D=c(v,0),O=c(S,0);G(t,D.x,D.y,O.x,O.y,{color:g.axis,dash:[6,6]});const H=c(0,0);if(tt(t,H.x,H.y,100,{color:g.lens}),A==="projection"){const r=c(-s,0),w=c(-s,28);if(Y(t,r.x,r.y,w.x,w.y,{color:g.accent}),M(t,"Light source",w.x,w.y-12,{background:"rgba(233, 69, 96, 0.2)"}),l==="real"){const z=-28*(a/s),W=c(a,0),V=c(a,z);Y(t,W.x,W.y,V.x,V.y,{color:g.rayGreen}),st(t,W.x-6,W.y-40,12,80),M(t,"Screen",W.x+26,W.y-30,{background:"rgba(179, 157, 219, 0.2)"})}else M(t,"No real focus",H.x+60,H.y-40,{background:"rgba(255, 255, 255, 0.08)"});const x={x:-s,y:28},T=-28/i,P={x:S,y:x.y+T*S};u([{x:x.x,y:x.y},{x:0,y:x.y},P],void 0,g.rayLeft);const R=(0-x.y)/(0-x.x),I={x:S,y:R*S};u([{x:x.x,y:x.y},{x:0,y:0},I],void 0,g.rayYellow),l==="virtual"&&u([{x:0,y:x.y},{x:a,y:x.y*(-a/s)}],[6,6],g.virtualImage),M(t,"Projection path",y.x+80,y.y+18,{background:"rgba(15, 52, 96, 0.4)"})}else{const r=c(-s,0);st(t,r.x-8,r.y-30,16,60),M(t,"Display",r.x-32,r.y-38,{background:"rgba(179, 157, 219, 0.2)"});const w=c(90,0);U(t,w.x,w.y,16,0),M(t,"Eye",w.x+28,w.y-16,{background:"rgba(255, 255, 255, 0.08)"});const x={x:-s,y:30},T={x:-s,y:-30},P={x:90};if(u([{x:x.x,y:x.y},{x:0,y:x.y},{x:P.x,y:x.y*.3}],void 0,g.rayLeft),u([{x:T.x,y:T.y},{x:0,y:T.y},{x:P.x,y:T.y*.3}],void 0,g.rayGreen),l==="virtual"){const R={x:a,y:0};u([{x:0,y:x.y},R],[6,6],g.virtualImage),u([{x:0,y:T.y},R],[6,6],g.virtualImage),M(t,"Virtual image",c(a,0).x-10,y.y+24,{background:"rgba(168, 85, 247, 0.25)"})}M(t,"HMD path",y.x+60,y.y+18,{background:"rgba(233, 69, 96, 0.25)"})}t.restore()};N(E[0],"projection"),N(E[1],"hmd")}}class Ct extends _{fInput;doInput;calloutEl;constructor(t){super(t),this.fInput=this.addSlider({id:"thin-lens-f",label:"Focal Length (mm)",min:10,max:200,step:1,value:40,unit:"mm"}),this.doInput=this.addSlider({id:"thin-lens-do",label:"Object Distance (mm)",min:5,max:500,step:1,value:80,unit:"mm"}),this.addReadout({id:"thin-lens-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"thin-lens-m",label:"Magnification",unit:"x"}),this.addReadout({id:"thin-lens-eq",label:"Lens Equation",unit:""}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.calloutEl.textContent="This is how HMD lenses work — display closer than f creates a magnified virtual image.",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.fInput.value),s=Number(this.doInput.value),a=vt(i,s),o=Math.abs(s-i)<1,n=o?Number.POSITIVE_INFINITY:a,l=o?"infinity":bt(n),h=Ft(a,s),m=l==="infinity"?"∞":a.toFixed(0),p=Number.isFinite(h)?h.toFixed(2):"--";this.setReadout("thin-lens-di",m),this.setReadout("thin-lens-m",p),this.setReadout("thin-lens-eq",`1/${i.toFixed(0)} = 1/${s.toFixed(0)} + 1/${m}`),this.calloutEl.style.display=s<i?"block":"none";const b=24,k=-220,E=220,N=-120,y=120,A=(this.width-b*2)/(E-k),v=(this.height-b*2)/(y-N),S=(T,P)=>({x:b+(T-k)*A,y:this.height-b-(P-N)*v}),C=(T,P,R)=>{at(t,T.map(I=>S(I.x,I.y)),{color:R??g.rayLeft,dash:P})},L=S(k,0),d=S(E,0);G(t,L.x,L.y,d.x,d.y,{color:g.axis,dash:[6,6]});const F=S(0,0);tt(t,F.x,F.y,140,{color:g.lens});const c=S(-i,0),u=S(i,0);M(t,"F",c.x,c.y-16,{color:g.text}),M(t,"F'",u.x,u.y-16,{color:g.text}),G(t,c.x,c.y-6,c.x,c.y+6,{color:g.axis,dash:[3,4]}),G(t,u.x,u.y-6,u.x,u.y+6,{color:g.axis,dash:[3,4]});const D=40,O=S(-s,0),H=S(-s,D);Y(t,O.x,O.y,H.x,H.y,{color:g.accent,width:2.5}),M(t,"Object",H.x,H.y-14,{background:"rgba(233, 69, 96, 0.2)"});const f={x:0,y:0},r={x:-s,y:D},w=E;if(l!=="infinity"){const T=D*h,P=a,R=S(P,0),I=S(P,T);l==="virtual"?(G(t,R.x,R.y,I.x,I.y,{color:g.virtualImage,dash:[6,6],width:2}),Y(t,R.x,R.y,I.x,I.y,{color:g.virtualImage,width:2,headSize:6})):Y(t,R.x,R.y,I.x,I.y,{color:g.rayGreen,width:2.5}),M(t,l==="virtual"?"Virtual Image":"Real Image",I.x,I.y-16,{background:l==="virtual"?"rgba(168, 85, 247, 0.25)":"rgba(76, 175, 80, 0.2)"})}else M(t,"Image at infinity",F.x+90,F.y-40,{background:"rgba(255, 255, 255, 0.08)"});if(l==="infinity")C([{x:r.x,y:r.y},{x:f.x,y:r.y},{x:w,y:r.y}],void 0,g.rayLeft),C([{x:r.x,y:r.y},{x:f.x,y:0},{x:w,y:r.y/s*w*-1}],void 0,g.rayYellow),C([{x:r.x,y:r.y},{x:0,y:r.y},{x:w,y:r.y}],void 0,g.rayGreen);else{const T=-40/i,P={x:w,y:r.y+T*w};C([{x:r.x,y:r.y},{x:0,y:r.y},{x:P.x,y:P.y}],void 0,g.rayLeft);const R=(f.y-r.y)/(f.x-r.x),I={x:w,y:f.y+R*w};C([{x:r.x,y:r.y},{x:f.x,y:f.y},{x:I.x,y:I.y}],void 0,g.rayYellow);const z=(0-r.y)/(-i-r.x),W=r.y+z*(0-r.x),V={x:w,y:W};if(C([{x:r.x,y:r.y},{x:0,y:W},{x:V.x,y:V.y}],void 0,g.rayGreen),l==="virtual"){const j={x:a,y:D*h};C([{x:0,y:r.y},j],[6,6],g.virtualImage),C([{x:0,y:f.y},j],[6,6],g.virtualImage),C([{x:0,y:W},j],[6,6],g.virtualImage)}}const x=l==="infinity"?"Object at f → image at infinity":s<i?"HMD regime: virtual image":"Projector regime: real image";M(t,x,F.x,F.y+90,{background:s<i?"rgba(233, 69, 96, 0.2)":"rgba(255, 255, 255, 0.08)"})}}class Ht extends _{depthInput;displayReadout;infoEl;constructor(t){super(t),this.depthInput=this.addSlider({id:"vac-depth",label:"Virtual Object Depth (m)",min:.3,max:10,step:.1,value:2,unit:"m"}),this.addReadout({id:"vac-mismatch",label:"Mismatch",unit:"D"}),this.displayReadout=this.addReadout({id:"vac-display",label:"Display Distance",unit:"m"}),this.infoEl=document.createElement("div"),this.infoEl.className="callout",this.infoEl.innerHTML="Industry solutions: varifocal displays, light field displays, foveated rendering.",this.controlsEl.appendChild(this.infoEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.depthInput.value),s=1.8,a=Lt(s,i);this.setReadout("vac-mismatch",a.toFixed(2)),this.displayReadout.textContent=s.toFixed(1);let o="Comfortable",n=g.rayGreen;a>St?(o="Eye strain likely",n=g.rayRight):a>kt&&(o="Mild discomfort",n=g.rayYellow);const l=18,h=20,m=(this.width-l*2-h)/2,p=this.height-l*2,b=[{x:l,y:l,width:m,height:p},{x:l+m+h,y:l,width:m,height:p}],k=(v,S,C,L,d)=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(v.x,v.y,v.width,v.height);const F=v.y+v.height*.55,c=v.width*.18,u=v.width*.08,D=v.x+v.width*.4,O=v.x+v.width*.6,f=Math.atan(.065/2/C),r=-f,w=f;U(t,D-c,F,u,r),U(t,O+c,F,u,w);const x=Math.max(.2,Math.min(1,1-(L-.3)/9.7)),T=u*(.4+.4*x),P=u*(.9+.2*x);t.fillStyle=d?"rgba(76, 175, 80, 0.4)":"rgba(255, 107, 107, 0.3)",t.beginPath(),t.ellipse(D-c+u*.3,F,T,P,0,0,Math.PI*2),t.fill(),t.beginPath(),t.ellipse(O+c-u*.3,F,T,P,0,0,Math.PI*2),t.fill();const R=v.y+v.height*.2;t.strokeStyle=d?g.rayGreen:g.rayRight,t.lineWidth=2,t.beginPath(),t.moveTo(D-c,F),t.lineTo(v.x+v.width*.5-20,R),t.moveTo(O+c,F),t.lineTo(v.x+v.width*.5+20,R),t.stroke(),M(t,S,v.x+v.width/2,v.y+18,{background:"rgba(15, 52, 96, 0.4)"}),M(t,d?"Vergence = Accommodation":"Vergence ≠ Accommodation",v.x+v.width/2,v.y+v.height-24,{background:d?"rgba(76, 175, 80, 0.2)":"rgba(255, 107, 107, 0.25)"}),t.restore()};k(b[0],"Natural Vision",i,i,!0),k(b[1],"VR Vision",i,s,!1);const E=b[1].x+18,N=b[1].y+b[1].height*.75,y=b[1].width-36;t.save(),t.fillStyle="rgba(255, 255, 255, 0.08)",t.fillRect(E,N,y,10),t.fillStyle=n;const A=Math.min(1,a/1);t.fillRect(E,N,y*A,10),t.restore(),M(t,o,E+y/2,N+22,{background:"rgba(0, 0, 0, 0.4)",color:n})}}class Wt extends _{ipdInput;nearInput;farInput;eyeReliefInput;calloutEl;constructor(t){super(t),this.ipdInput=this.addSlider({id:"frustum-ipd",label:"IPD (mm)",min:52,max:78,step:1,value:63,unit:"mm"}),this.nearInput=this.addSlider({id:"frustum-near",label:"Near Plane (m)",min:.01,max:.5,step:.01,value:.06,unit:"m"}),this.farInput=this.addSlider({id:"frustum-far",label:"Far Plane (m)",min:.5,max:100,step:.1,value:1.56,unit:"m"}),this.eyeReliefInput=this.addSlider({id:"frustum-eye-relief",label:"Eye Relief (mm)",min:8,max:25,step:1,value:18,unit:"mm"}),this.addReadout({id:"frustum-left",label:"Left Eye L/R",unit:"m"}),this.addReadout({id:"frustum-right",label:"Right Eye L/R",unit:"m"}),this.addReadout({id:"frustum-v",label:"Top/Bottom",unit:"m"}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.calloutEl.textContent="Frustum culling removes objects outside the view; each eye needs a unique asymmetric projection matrix.",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.ipdInput.value),s=Number(this.nearInput.value),a=Number(this.farInput.value),o=Number(this.eyeReliefInput.value),n=wt({...Z,ipd:i/1e3,eyeRelief:o/1e3}),l=s/n.distEye2Display,h=n.leftForLeftEye*l,m=n.rightForLeftEye*l,p=n.leftForRightEye*l,b=n.rightForRightEye*l,k=s*n.imgHeight/(2*n.distEye2Img),E=-k;this.setReadout("frustum-left",`${h.toFixed(3)}, ${m.toFixed(3)}`),this.setReadout("frustum-right",`${p.toFixed(3)}, ${b.toFixed(3)}`),this.setReadout("frustum-v",`${k.toFixed(3)}, ${E.toFixed(3)}`);const N=18,y=24,A=(this.height-N*2-y)/2,v=this.width-N*2,S=[{x:N,y:N,width:v,height:A},{x:N,y:N+A+y,width:v,height:A}],C=d=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(d.x,d.y,d.width,d.height);const F=-200,c=200,u=0,D=a*1e3*1.1,O=d.width/(c-F),H=d.height/(D-u),f=(X,B)=>({x:d.x+(X-F)*O,y:d.y+d.height-(B-u)*H}),r=-i/2,w=i/2,x=s*1e3,T=a*1e3,P=a/s,R=r+h*1e3,I=r+m*1e3,z=r+h*1e3*P,W=r+m*1e3*P,V=w+p*1e3,j=w+b*1e3,$=w+p*1e3*P,q=w+b*1e3*P,ot=(X,B,K,J,It,dt)=>{t.save(),t.fillStyle=dt,t.strokeStyle=dt,t.beginPath();const ht=f(X,0);t.moveTo(ht.x,ht.y);const yt=f(B,x),ut=f(K,x),mt=f(It,T),gt=f(J,T);t.lineTo(yt.x,yt.y),t.lineTo(gt.x,gt.y),t.lineTo(mt.x,mt.y),t.lineTo(ut.x,ut.y),t.closePath(),t.globalAlpha=.18,t.fill(),t.globalAlpha=.8,t.stroke(),t.restore()};ot(r,R,I,z,W,g.rayLeft),ot(w,V,j,$,q,g.rayRight);const nt=Math.max(R,V),lt=Math.min(I,j),Tt=Math.max(z,$),Rt=Math.min(W,q);if(nt<lt){t.save(),t.fillStyle=g.overlap,t.beginPath();const X=f(nt,x),B=f(lt,x),K=f(Rt,T),J=f(Tt,T);t.moveTo(X.x,X.y),t.lineTo(B.x,B.y),t.lineTo(K.x,K.y),t.lineTo(J.x,J.y),t.closePath(),t.fill(),t.restore()}const rt=f(F,0),ct=f(c,0);G(t,rt.x,rt.y,ct.x,ct.y,{color:g.axis,dash:[5,6]}),M(t,"Top-down frustum (horizontal)",d.x+140,d.y+18,{background:"rgba(15, 52, 96, 0.4)"}),t.restore()},L=d=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(d.x,d.y,d.width,d.height);const F=-80,c=80,u=0,D=a*1e3*1.1,O=d.width/(c-F),H=d.height/(D-u),f=(I,z)=>({x:d.x+(I-F)*O,y:d.y+d.height-(z-u)*H}),r=s*1e3,w=a*1e3,x=a/s,T=k*1e3,P=T*x,R=[{x:0,y:0},{x:-T,y:r},{x:-P,y:w},{x:P,y:w},{x:T,y:r}];t.save(),t.strokeStyle=g.rayGreen,t.globalAlpha=.8,t.beginPath(),R.forEach((I,z)=>{const W=f(I.x,I.y);z===0?t.moveTo(W.x,W.y):t.lineTo(W.x,W.y)}),t.closePath(),t.stroke(),t.restore(),M(t,"Side view (vertical symmetric)",d.x+140,d.y+18,{background:"rgba(233, 69, 96, 0.25)"}),t.restore()};C(S[0]),L(S[1])}}const Ot=new Map([["thin-lens",e=>new Ct(e)],["light-path",e=>new Dt(e)],["params",e=>new Nt(e)],["frustum",e=>new Wt(e)],["distortion",e=>new Pt(e)],["vac",e=>new Ht(e)]]),At=["thin-lens","light-path","params","frustum","distortion","vac"];function zt(){document.querySelectorAll("[data-panel]").forEach(e=>{const t=e.dataset.panel;if(!t)return;const i=Ot.get(t);i&&i(e)})}function Et(){const e=window.location.hash;if(!e)return;const t=document.querySelector(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function Vt(){const e=document.querySelectorAll(".sidebar-nav a"),t=document.querySelectorAll('.site-nav a[href^="#"]'),i=a=>{e.forEach(o=>{o.classList.toggle("active",o.getAttribute("data-sidebar")===a)}),t.forEach(o=>{const n=o.getAttribute("href");o.classList.toggle("active",n===`#${a}`)})},s=new IntersectionObserver(a=>{for(const o of a)o.isIntersecting&&i(o.target.id)},{rootMargin:"-20% 0px -60% 0px",threshold:0});At.forEach(a=>{const o=document.getElementById(a);o&&s.observe(o)})}window.addEventListener("hashchange",Et);zt();Vt();setTimeout(Et,50);
