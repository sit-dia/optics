(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const n of a)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function i(a){const n={};return a.integrity&&(n.integrity=a.integrity),a.referrerPolicy&&(n.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?n.credentials="include":a.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(a){if(a.ep)return;a.ep=!0;const n=i(a);fetch(a.href,n)}})();const Mt='12px "Space Grotesk", system-ui, sans-serif';function q(e,t,i,s,a,n={}){const{color:o="#eaeaea",width:l=2,headSize:d=8}=n,m=Math.atan2(a-i,s-t);e.save(),e.strokeStyle=o,e.lineWidth=l,e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.stroke(),e.beginPath(),e.moveTo(s,a),e.lineTo(s-d*Math.cos(m-Math.PI/6),a-d*Math.sin(m-Math.PI/6)),e.lineTo(s-d*Math.cos(m+Math.PI/6),a-d*Math.sin(m+Math.PI/6)),e.closePath(),e.fillStyle=o,e.fill(),e.restore()}function tt(e,t,i,s,a={}){const{color:n="#ffd700",width:o=2}=a;e.save(),e.strokeStyle=n,e.lineWidth=o,e.beginPath(),e.moveTo(t,i-s/2),e.lineTo(t,i+s/2),e.stroke(),q(e,t,i-s/2,t,i-s/2-12,{color:n,width:o,headSize:6}),q(e,t,i+s/2,t,i+s/2+12,{color:n,width:o,headSize:6}),e.restore()}function G(e,t,i,s,a,n={}){const{color:o="#888888",width:l=1,dash:d=[6,6]}=n;e.save(),e.strokeStyle=o,e.lineWidth=l,e.setLineDash(d),e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.stroke(),e.restore()}function U(e,t,i,s,a=0){e.save(),e.translate(t,i),e.rotate(a),e.strokeStyle="#eaeaea",e.lineWidth=2,e.beginPath(),e.arc(0,0,s,0,Math.PI*2),e.stroke(),e.fillStyle="#11121d",e.beginPath(),e.arc(s*.2,0,s*.35,0,Math.PI*2),e.fill(),e.restore()}function st(e,t,i,s,a){e.save(),e.fillStyle="rgba(179, 157, 219, 0.35)",e.strokeStyle="#b39ddb",e.lineWidth=2,e.fillRect(t,i,s,a),e.strokeRect(t,i,s,a),e.restore()}function pt(e,t,i,s,a,n,o=12){e.save(),e.strokeStyle="#888888",e.lineWidth=1;const l=s-t,d=a-i,m=Math.hypot(l,d);if(m===0)return;const p=-d/m,b=l/m,k=p*o,R=b*o;e.beginPath(),e.moveTo(t+k,i+R),e.lineTo(s+k,a+R),e.stroke(),e.beginPath(),e.moveTo(t+k,i+R),e.lineTo(t+k+p*6,i+R+b*6),e.stroke(),e.beginPath(),e.moveTo(s+k,a+R),e.lineTo(s+k+p*6,a+R+b*6),e.stroke(),M(e,n,(t+s)/2+k,(i+a)/2+R),e.restore()}function at(e,t,i={}){const{color:s="#4da6ff",width:a=2,dash:n,glow:o}=i;e.save(),e.strokeStyle=s,e.lineWidth=a,n&&e.setLineDash(n),o&&(e.shadowColor=s,e.shadowBlur=8),e.beginPath(),t.forEach((l,d)=>{d===0?e.moveTo(l.x,l.y):e.lineTo(l.x,l.y)}),e.stroke(),e.restore()}function ft(e,t,i,s){const{width:a,height:n}=e.canvas;e.save(),e.strokeStyle="#444444",e.lineWidth=1;for(let o=0;o<=t;o+=1){const l=o/t*n;e.beginPath();for(let d=0;d<=i;d+=1){const m=d/i*a,p=s?s(m,l):{x:m,y:l};d===0?e.moveTo(p.x,p.y):e.lineTo(p.x,p.y)}e.stroke()}for(let o=0;o<=i;o+=1){const l=o/i*a;e.beginPath();for(let d=0;d<=t;d+=1){const m=d/t*n,p=s?s(l,m):{x:l,y:m};d===0?e.moveTo(p.x,p.y):e.lineTo(p.x,p.y)}e.stroke()}e.restore()}function M(e,t,i,s,a={}){const{color:n="#eaeaea",background:o="rgba(0, 0, 0, 0.45)",padding:l=4,font:d=Mt}=a;e.save(),e.font=d;const p=e.measureText(t).width+l*2,b=16+l;e.fillStyle=o,e.fillRect(i-p/2,s-b/2,p,b),e.fillStyle=n,e.textAlign="center",e.textBaseline="middle",e.fillText(t,i,s+1),e.restore()}const Z={f:.043,distLens2Display:.042,eyeRelief:.018,ipd:.065,displayWidth:.12096,displayHeight:.068},Q={k1:.34,k2:.55},g={accent:"#e94560",text:"#eaeaea",rayLeft:"#4da6ff",rayRight:"#ff6b6b",rayGreen:"#4caf50",rayYellow:"#ffc107",virtualImage:"#a855f7",overlap:"rgba(128, 0, 255, 0.15)",lens:"#ffd700",axis:"#555555"},kt=.3,St=.5;function vt(e,t){return 1/(1/e-1/t)}function Pt(e,t){return-e/t}function bt(e){return!Number.isFinite(e)||Math.abs(e)>1e6?"infinity":e>0?"real":"virtual"}const et=180/Math.PI;function wt(e){const{f:t,distLens2Display:i,eyeRelief:s,ipd:a,displayWidth:n,displayHeight:o}=e,l=t/(t-i),d=Math.abs(1/(1/t-1/i)),m=d+s,p=s+i,b=o*l,k=2*Math.atan(b/2/m)*et,R=Math.atan(l*a/2/m)*et,N=Math.atan(l*(n-a)/2/m)*et,y=R+N,z=s+i,v=z*b/(2*m),S=-v,C=l*a/2,F=l*(n-a)/2,h=p*C/m,P=-(p*F)/m,c=p*F/m,u=-(p*C)/m;return{distEye2Display:p,magnification:l,imgHeight:b,distLens2Img:d,distEye2Img:m,near:z,fovVertical:k,fovHNasal:R,fovHTemporal:N,fovHorizontal:y,top:v,bottom:S,imgWidthNasal:C,imgWidthTemporal:F,leftForLeftEye:P,rightForLeftEye:h,leftForRightEye:u,rightForRightEye:c}}function it(e,t,i,s,a,n){const o=e-i,l=t-s,d=o*o+l*l,m=1+a*d+n*d*d;return{x:i+o*m,y:s+l*m}}function xt(e){return 1/e}function Ft(e,t){return Math.abs(xt(e)-xt(t))}class _{container;canvas;ctx;controlsEl;readoutsEl;width=0;height=0;resizeObserver;rafId=null;resizeTimer=null;constructor(t){this.container=t;const i=t.querySelector("[data-canvas]"),s=t.querySelector("[data-controls]"),a=t.querySelector("[data-readouts]");if(!i||!s||!a)throw new Error("Panel container missing required elements");this.controlsEl=s,this.readoutsEl=a,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("aria-label","Optics visualization"),i.appendChild(this.canvas);const n=this.canvas.getContext("2d");if(!n)throw new Error("Canvas context unavailable");this.ctx=n,this.resizeObserver=new ResizeObserver(()=>this.scheduleResize()),this.resizeObserver.observe(i),this.resize()}scheduleResize(){this.resizeTimer!==null&&window.clearTimeout(this.resizeTimer),this.resizeTimer=window.setTimeout(()=>{this.resizeTimer=null,this.resize()},120)}resize(){const t=this.canvas.parentElement?.getBoundingClientRect();if(!t)return;const i=window.devicePixelRatio||1;this.canvas.width=Math.floor(t.width*i),this.canvas.height=Math.floor(t.height*i),this.canvas.style.width=`${t.width}px`,this.canvas.style.height=`${t.height}px`,this.width=t.width,this.height=t.height,this.ctx.setTransform(i,0,0,i,0,0),this.requestDraw()}requestDraw(){this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.render()})}addSlider(t){const i=document.createElement("div");i.className="control-row";const s=document.createElement("label");s.htmlFor=t.id,s.textContent=t.label;const a=document.createElement("div");a.className="value";const n=document.createElement("input");n.id=t.id,n.type="range",n.min=String(t.min),n.max=String(t.max),n.step=String(t.step),n.value=String(t.value);const o=l=>{const d=Number(l);a.textContent=`${d}${t.unit??""}`,t.onChange?.(d),this.requestDraw()};return n.addEventListener("input",()=>o(n.value)),o(n.value),i.appendChild(s),i.appendChild(n),i.appendChild(a),this.controlsEl.appendChild(i),n}addReadout(t){const i=document.createElement("div");i.className="readout",i.dataset.readout=t.id;const s=document.createElement("span");s.textContent=t.label;const a=document.createElement("span");return a.textContent=`--${t.unit??""}`,i.appendChild(s),i.appendChild(a),this.readoutsEl.appendChild(i),a}setReadout(t,i){const s=this.readoutsEl.querySelector(`[data-readout="${t}"] span:last-child`);s&&(s.textContent=i)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}render(){this.clear();const{width:t,height:i}=this;this.ctx.fillStyle="#101424",this.ctx.fillRect(0,0,t,i),this.ctx.fillStyle="#eaeaea",this.ctx.font='14px "Space Grotesk", system-ui, sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Panel rendering...",t/2,i/2)}dispose(){this.resizeObserver.disconnect(),this.resizeTimer!==null&&(window.clearTimeout(this.resizeTimer),this.resizeTimer=null)}}class Lt extends _{k1Input;k2Input;gridInput;preToggle;constructor(t){super(t),this.k1Input=this.addSlider({id:"distortion-k1",label:"k1",min:-1,max:1,step:.01,value:Q.k1}),this.k2Input=this.addSlider({id:"distortion-k2",label:"k2",min:-1,max:1,step:.01,value:Q.k2}),this.gridInput=this.addSlider({id:"distortion-grid",label:"Grid Density",min:4,max:20,step:1,value:8});const i=document.createElement("div");i.className="control-row";const s=document.createElement("label");s.textContent="Pre-correction",this.preToggle=document.createElement("input"),this.preToggle.type="checkbox",this.preToggle.checked=!1,this.preToggle.addEventListener("change",()=>this.requestDraw()),i.appendChild(s),i.appendChild(this.preToggle),this.controlsEl.appendChild(i)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.k1Input.value),s=Number(this.k2Input.value),a=Number(this.gridInput.value),n=16,o=18,l=(this.height-n*2-o*2)/3,d=this.width-n*2,m=[{x:n,y:n,width:d,height:l},{x:n,y:n+l+o,width:d,height:l},{x:n,y:n+(l+o)*2,width:d,height:l}],p=(c,u,D,O=0,H=0)=>{t.save(),t.beginPath(),t.rect(c.x,c.y,c.width,c.height),t.clip(),t.translate(c.x,c.y),t.scale(c.width/t.canvas.width,c.height/t.canvas.height);const f=t.canvas.width,r=t.canvas.height,w=f/2,x=r/2,E=Math.min(f,r)/2;ft(t,u,D,O!==0||H!==0?(T,I)=>{const V=(T-w)/E,W=(I-x)/E,j=it(V,W,0,0,O,H);return{x:w+j.x*E,y:x+j.y*E}}:void 0),t.restore()},b=m[0],k=m[1],R=m[2],N=(b.width-o)/2,y={x:b.x,y:b.y,width:N,height:b.height},z={x:b.x+N+o,y:b.y,width:N,height:b.height};p(y,a,a,Q.k1,Q.k2),p(z,a,a,-.34,-.55),M(t,"Barrel distortion",y.x+90,y.y+18,{background:"rgba(233, 69, 96, 0.25)"}),M(t,"Pincushion distortion",z.x+100,z.y+18,{background:"rgba(15, 52, 96, 0.4)"});const v=12,S=4,C=(k.width-v*(S-1))/S,F=k.height,h=Array.from({length:S},(c,u)=>({x:k.x+u*(C+v),y:k.y,width:C,height:F}));p(h[0],8,8),M(t,"Original",h[0].x+40,h[0].y+18,{background:"rgba(255, 255, 255, 0.08)"}),p(h[1],8,8,-i,-s),M(t,"Pre-distort",h[1].x+46,h[1].y+18,{background:"rgba(15, 52, 96, 0.4)"}),p(h[2],8,8,i,s),M(t,"Lens barrel",h[2].x+46,h[2].y+18,{background:"rgba(233, 69, 96, 0.25)"}),p(h[3],8,8,0,0),M(t,"Straight",h[3].x+42,h[3].y+18,{background:"rgba(76, 175, 80, 0.2)"});for(let c=0;c<h.length-1;c+=1){const u=h[c],D=h[c+1];q(t,u.x+u.width+4,u.y+u.height/2,D.x-4,D.y+D.height/2,{color:"#eaeaea",width:1.5,headSize:6})}const P=this.preToggle.checked?"Pre-correction ON → canceling barrel":"Interactive distortion playground";if(M(t,P,R.x+120,R.y+18,{background:"rgba(255, 255, 255, 0.08)"}),this.preToggle.checked){const c=(u,D)=>{const O=t.canvas.width/2,H=t.canvas.height/2,f=Math.min(t.canvas.width,t.canvas.height)/2,r=(u-O)/f,w=(D-H)/f,x=it(r,w,0,0,-i,-s),E=it(x.x,x.y,0,0,i,s);return{x:O+E.x*f,y:H+E.y*f}};t.save(),t.beginPath(),t.rect(R.x,R.y,R.width,R.height),t.clip(),t.translate(R.x,R.y),t.scale(R.width/t.canvas.width,R.height/t.canvas.height),ft(t,a,a,c),t.restore()}else p(R,a,a,i,s)}}class Nt extends _{ipdInput;eyeReliefInput;fInput;doInput;fovToggle;warningEl;constructor(t){super(t),this.ipdInput=this.addSlider({id:"params-ipd",label:"IPD (mm)",min:52,max:78,step:1,value:63,unit:"mm"}),this.eyeReliefInput=this.addSlider({id:"params-eye-relief",label:"Eye Relief (mm)",min:8,max:25,step:1,value:18,unit:"mm"}),this.fInput=this.addSlider({id:"params-f",label:"Focal Length (mm)",min:30,max:60,step:1,value:43,unit:"mm"}),this.doInput=this.addSlider({id:"params-do",label:"Lens to Display (mm)",min:30,max:55,step:1,value:42,unit:"mm"});const i=document.createElement("div");i.className="control-row";const s=document.createElement("label");s.textContent="Show FOV breakdown",this.fovToggle=document.createElement("input"),this.fovToggle.type="checkbox",this.fovToggle.checked=!0,this.fovToggle.addEventListener("change",()=>this.requestDraw()),i.appendChild(s),i.appendChild(this.fovToggle),this.controlsEl.appendChild(i),this.addReadout({id:"params-mag",label:"Magnification",unit:"x"}),this.addReadout({id:"params-img",label:"Virtual Image Dist",unit:"mm"}),this.addReadout({id:"params-eye-img",label:"Eye-to-Image",unit:"mm"}),this.addReadout({id:"params-fov-v",label:"FOV Vertical",unit:"deg"}),this.addReadout({id:"params-fov-nasal",label:"FOV H-Nasal",unit:"deg"}),this.addReadout({id:"params-fov-temporal",label:"FOV H-Temporal",unit:"deg"}),this.addReadout({id:"params-fov",label:"FOV H-Total",unit:"deg"}),this.addReadout({id:"params-near",label:"Near Plane",unit:"mm"}),this.warningEl=document.createElement("div"),this.warningEl.className="callout",this.warningEl.textContent="Extreme IPD values can reduce comfort.",this.controlsEl.appendChild(this.warningEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.ipdInput.value),s=Number(this.eyeReliefInput.value),a=Number(this.fInput.value),n=Number(this.doInput.value),o=wt({...Z,ipd:i/1e3,eyeRelief:s/1e3,f:a/1e3,distLens2Display:n/1e3});this.setReadout("params-mag",o.magnification.toFixed(2)),this.setReadout("params-img",(o.distLens2Img*1e3).toFixed(0)),this.setReadout("params-eye-img",(o.distEye2Img*1e3).toFixed(0)),this.setReadout("params-fov-v",o.fovVertical.toFixed(1)),this.setReadout("params-fov-nasal",o.fovHNasal.toFixed(1)),this.setReadout("params-fov-temporal",o.fovHTemporal.toFixed(1)),this.setReadout("params-fov",o.fovHorizontal.toFixed(1)),this.setReadout("params-near",(o.near*1e3).toFixed(0));const l=i<56||i>72;this.warningEl.style.display=l?"block":"none";const d=20,m=-120,p=120,b=-140,k=80,R=(this.width-d*2)/(p-m),N=(this.height-d*2)/(k-b),y=(j,A)=>({x:d+(j-m)*R,y:this.height-d-(A-b)*N}),z=(j,A,$)=>{at(t,j.map(Y=>y(Y.x,Y.y)),{color:A,dash:$})},v=Z.displayWidth*1e3,S=14,C=-n,F=s,h=0,P=y(-v/2,C+S/2);st(t,P.x,P.y,v*R,S*N),M(t,"Display",P.x+42,P.y-12,{background:"rgba(179, 157, 219, 0.2)"});const c=-i/2,u=i/2,D=y(c,F),O=y(u,F);U(t,D.x,D.y,12,0),U(t,O.x,O.y,12,0);const H=y(c,h),f=y(u,h);tt(t,H.x,H.y,32,{color:g.lens}),tt(t,f.x,f.y,32,{color:g.lens});const r=s+o.distLens2Img*1e3,w=o.magnification*Z.displayWidth*1e3,x=y(-w/2,r+8);G(t,x.x,x.y,x.x+w*R,x.y,{color:g.virtualImage,dash:[6,6],width:1.5}),M(t,"Virtual image",x.x+50,x.y-14,{background:"rgba(168, 85, 247, 0.25)"});const E=o.imgWidthNasal*1e3,L=o.imgWidthTemporal*1e3,T={x:c+E,y:r},I={x:c-L,y:r},V={x:u-E,y:r},W={x:u+L,y:r};if(z([{x:c,y:F},{x:T.x,y:T.y}],g.rayLeft),z([{x:c,y:F},{x:I.x,y:I.y}],g.rayLeft),z([{x:u,y:F},{x:V.x,y:V.y}],g.rayRight),z([{x:u,y:F},{x:W.x,y:W.y}],g.rayRight),this.fovToggle.checked){if(T.x<V.x){const j=y(c,F),A=y(u,F),$=y(T.x,T.y),Y=y(V.x,V.y);t.save(),t.fillStyle=g.overlap,t.beginPath(),t.moveTo(j.x,j.y),t.lineTo(A.x,A.y),t.lineTo(Y.x,Y.y),t.lineTo($.x,$.y),t.closePath(),t.fill(),t.restore()}M(t,"Nasal",y(T.x,T.y).x+12,y(T.x,T.y).y-12,{background:"rgba(255, 255, 255, 0.08)"}),M(t,"Temporal",y(I.x,I.y).x-12,y(I.x,I.y).y-12,{background:"rgba(255, 255, 255, 0.08)"})}pt(t,y(c,F).x,y(c,F).y+22,y(u,F).x,y(u,F).y+22,`IPD ${i.toFixed(0)}mm`,10),pt(t,y(u+18,h).x,y(u+18,h).y,y(u+18,F).x,y(u+18,F).y,`Eye relief ${s.toFixed(0)}mm`,8),M(t,"Top-down HMD cross-section",y(0,k-10).x,28,{background:"rgba(15, 52, 96, 0.4)"})}}class Dt extends _{fInput;doInput;calloutEl;constructor(t){super(t),this.fInput=this.addSlider({id:"light-path-f",label:"Focal Length (mm)",min:20,max:100,step:1,value:43,unit:"mm"}),this.doInput=this.addSlider({id:"light-path-do",label:"Object Distance (mm)",min:10,max:120,step:1,value:42,unit:"mm"}),this.addReadout({id:"light-path-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"light-path-regime",label:"Regime",unit:""}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.fInput.value),s=Number(this.doInput.value),a=vt(i,s),n=Math.abs(s-i)<1,o=n?Number.POSITIVE_INFINITY:a,l=n?"infinity":bt(o),d=l==="infinity"?"∞":a.toFixed(0);this.setReadout("light-path-di",d),this.setReadout("light-path-regime",s<i?"HMD (virtual image)":"Projection (real image)"),this.calloutEl.textContent=s<i?"Display inside focal length → virtual, magnified image (HMD regime).":"Object beyond focal length → real inverted image (projection regime).";const m=18,p=24,b=(this.height-m*2-p)/2,k=this.width-m*2,R=[{x:m,y:m,width:k,height:b},{x:m,y:m+b+p,width:k,height:b}],N=(y,z)=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(y.x,y.y,y.width,y.height);const v=-130,S=170,C=-80,F=80,h=y.width/(S-v),P=y.height/(F-C),c=(f,r)=>({x:y.x+(f-v)*h,y:y.y+y.height-(r-C)*P}),u=(f,r,w)=>{at(t,f.map(x=>c(x.x,x.y)),{color:w??g.rayLeft,dash:r})},D=c(v,0),O=c(S,0);G(t,D.x,D.y,O.x,O.y,{color:g.axis,dash:[6,6]});const H=c(0,0);if(tt(t,H.x,H.y,100,{color:g.lens}),z==="projection"){const r=c(-s,0),w=c(-s,28);if(q(t,r.x,r.y,w.x,w.y,{color:g.accent}),M(t,"Light source",w.x,w.y-12,{background:"rgba(233, 69, 96, 0.2)"}),l==="real"){const V=-28*(a/s),W=c(a,0),j=c(a,V);q(t,W.x,W.y,j.x,j.y,{color:g.rayGreen}),st(t,W.x-6,W.y-40,12,80),M(t,"Screen",W.x+26,W.y-30,{background:"rgba(179, 157, 219, 0.2)"})}else M(t,"No real focus",H.x+60,H.y-40,{background:"rgba(255, 255, 255, 0.08)"});const x={x:-s,y:28},E=-28/i,L={x:S,y:x.y+E*S};u([{x:x.x,y:x.y},{x:0,y:x.y},L],void 0,g.rayLeft);const T=(0-x.y)/(0-x.x),I={x:S,y:T*S};u([{x:x.x,y:x.y},{x:0,y:0},I],void 0,g.rayYellow),l==="virtual"&&u([{x:0,y:x.y},{x:a,y:x.y*(-a/s)}],[6,6],g.virtualImage),M(t,"Projection path",y.x+80,y.y+18,{background:"rgba(15, 52, 96, 0.4)"})}else{const r=c(-s,0);st(t,r.x-8,r.y-30,16,60),M(t,"Display",r.x-32,r.y-38,{background:"rgba(179, 157, 219, 0.2)"});const w=c(90,0);U(t,w.x,w.y,16,0),M(t,"Eye",w.x+28,w.y-16,{background:"rgba(255, 255, 255, 0.08)"});const x={x:-s,y:30},E={x:-s,y:-30},L={x:90};if(u([{x:x.x,y:x.y},{x:0,y:x.y},{x:L.x,y:x.y*.3}],void 0,g.rayLeft),u([{x:E.x,y:E.y},{x:0,y:E.y},{x:L.x,y:E.y*.3}],void 0,g.rayGreen),l==="virtual"){const T={x:a,y:0};u([{x:0,y:x.y},T],[6,6],g.virtualImage),u([{x:0,y:E.y},T],[6,6],g.virtualImage),M(t,"Virtual image",c(a,0).x-10,y.y+24,{background:"rgba(168, 85, 247, 0.25)"})}M(t,"HMD path",y.x+60,y.y+18,{background:"rgba(233, 69, 96, 0.25)"})}t.restore()};N(R[0],"projection"),N(R[1],"hmd")}}class Ct extends _{fInput;doInput;calloutEl;constructor(t){super(t),this.fInput=this.addSlider({id:"thin-lens-f",label:"Focal Length (mm)",min:10,max:200,step:1,value:40,unit:"mm"}),this.doInput=this.addSlider({id:"thin-lens-do",label:"Object Distance (mm)",min:5,max:500,step:1,value:80,unit:"mm"}),this.addReadout({id:"thin-lens-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"thin-lens-m",label:"Magnification",unit:"x"}),this.addReadout({id:"thin-lens-eq",label:"Lens Equation",unit:""}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.calloutEl.textContent="This is how HMD lenses work — display closer than f creates a magnified virtual image.",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.fInput.value),s=Number(this.doInput.value),a=vt(i,s),n=Math.abs(s-i)<1,o=n?Number.POSITIVE_INFINITY:a,l=n?"infinity":bt(o),d=Pt(a,s),m=l==="infinity"?"∞":a.toFixed(0),p=Number.isFinite(d)?d.toFixed(2):"--";this.setReadout("thin-lens-di",m),this.setReadout("thin-lens-m",p),this.setReadout("thin-lens-eq",`1/${i.toFixed(0)} = 1/${s.toFixed(0)} + 1/${m}`),this.calloutEl.style.display=s<i?"block":"none";const b=24,k=-220,R=220,N=-120,y=120,z=(this.width-b*2)/(R-k),v=(this.height-b*2)/(y-N),S=(E,L)=>({x:b+(E-k)*z,y:this.height-b-(L-N)*v}),C=(E,L,T)=>{at(t,E.map(I=>S(I.x,I.y)),{color:T??g.rayLeft,dash:L})},F=S(k,0),h=S(R,0);G(t,F.x,F.y,h.x,h.y,{color:g.axis,dash:[6,6]});const P=S(0,0);tt(t,P.x,P.y,140,{color:g.lens});const c=S(-i,0),u=S(i,0);M(t,"F",c.x,c.y-16,{color:g.text}),M(t,"F'",u.x,u.y-16,{color:g.text}),G(t,c.x,c.y-6,c.x,c.y+6,{color:g.axis,dash:[3,4]}),G(t,u.x,u.y-6,u.x,u.y+6,{color:g.axis,dash:[3,4]});const D=40,O=S(-s,0),H=S(-s,D);q(t,O.x,O.y,H.x,H.y,{color:g.accent,width:2.5}),M(t,"Object",H.x,H.y-14,{background:"rgba(233, 69, 96, 0.2)"});const f={x:0,y:0},r={x:-s,y:D},w=R;if(l!=="infinity"){const E=D*d,L=a,T=S(L,0),I=S(L,E);l==="virtual"?(G(t,T.x,T.y,I.x,I.y,{color:g.virtualImage,dash:[6,6],width:2}),q(t,T.x,T.y,I.x,I.y,{color:g.virtualImage,width:2,headSize:6})):q(t,T.x,T.y,I.x,I.y,{color:g.rayGreen,width:2.5}),M(t,l==="virtual"?"Virtual Image":"Real Image",I.x,I.y-16,{background:l==="virtual"?"rgba(168, 85, 247, 0.25)":"rgba(76, 175, 80, 0.2)"})}else M(t,"Image at infinity",P.x+90,P.y-40,{background:"rgba(255, 255, 255, 0.08)"});if(l==="infinity")C([{x:r.x,y:r.y},{x:f.x,y:r.y},{x:w,y:r.y}],void 0,g.rayLeft),C([{x:r.x,y:r.y},{x:f.x,y:0},{x:w,y:r.y/s*w*-1}],void 0,g.rayYellow),C([{x:r.x,y:r.y},{x:0,y:r.y},{x:w,y:r.y}],void 0,g.rayGreen);else{const E=-40/i,L={x:w,y:r.y+E*w};C([{x:r.x,y:r.y},{x:0,y:r.y},{x:L.x,y:L.y}],void 0,g.rayLeft);const T=(f.y-r.y)/(f.x-r.x),I={x:w,y:f.y+T*w};C([{x:r.x,y:r.y},{x:f.x,y:f.y},{x:I.x,y:I.y}],void 0,g.rayYellow);const V=(0-r.y)/(-i-r.x),W=r.y+V*(0-r.x),j={x:w,y:W};if(C([{x:r.x,y:r.y},{x:0,y:W},{x:j.x,y:j.y}],void 0,g.rayGreen),l==="virtual"){const A={x:a,y:D*d};C([{x:0,y:r.y},A],[6,6],g.virtualImage),C([{x:0,y:f.y},A],[6,6],g.virtualImage),C([{x:0,y:W},A],[6,6],g.virtualImage)}}const x=l==="infinity"?"Object at f → image at infinity":s<i?"HMD regime: virtual image":"Projector regime: real image";M(t,x,P.x,P.y+90,{background:s<i?"rgba(233, 69, 96, 0.2)":"rgba(255, 255, 255, 0.08)"})}}class Ht extends _{depthInput;displayReadout;infoEl;constructor(t){super(t),this.depthInput=this.addSlider({id:"vac-depth",label:"Virtual Object Depth (m)",min:.3,max:10,step:.1,value:2,unit:"m"}),this.addReadout({id:"vac-mismatch",label:"Mismatch",unit:"D"}),this.displayReadout=this.addReadout({id:"vac-display",label:"Display Distance",unit:"m"}),this.infoEl=document.createElement("div"),this.infoEl.className="callout",this.infoEl.innerHTML="Industry solutions: varifocal displays, light field displays, foveated rendering.",this.controlsEl.appendChild(this.infoEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.depthInput.value),s=1.8,a=Ft(s,i);this.setReadout("vac-mismatch",a.toFixed(2)),this.displayReadout.textContent=s.toFixed(1);let n="Comfortable",o=g.rayGreen;a>St?(n="Eye strain likely",o=g.rayRight):a>kt&&(n="Mild discomfort",o=g.rayYellow);const l=18,d=20,m=(this.width-l*2-d)/2,p=this.height-l*2,b=[{x:l,y:l,width:m,height:p},{x:l+m+d,y:l,width:m,height:p}],k=(v,S,C,F,h)=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(v.x,v.y,v.width,v.height);const P=v.y+v.height*.55,c=v.width*.18,u=v.width*.08,D=v.x+v.width*.4,O=v.x+v.width*.6,f=Math.atan(.065/2/C),r=-f,w=f;U(t,D-c,P,u,r),U(t,O+c,P,u,w);const x=Math.max(.2,Math.min(1,1-(F-.3)/9.7)),E=u*(.4+.4*x),L=u*(.9+.2*x);t.fillStyle=h?"rgba(76, 175, 80, 0.4)":"rgba(255, 107, 107, 0.3)",t.beginPath(),t.ellipse(D-c+u*.3,P,E,L,0,0,Math.PI*2),t.fill(),t.beginPath(),t.ellipse(O+c-u*.3,P,E,L,0,0,Math.PI*2),t.fill();const T=v.y+v.height*.2;t.strokeStyle=h?g.rayGreen:g.rayRight,t.lineWidth=2,t.beginPath(),t.moveTo(D-c,P),t.lineTo(v.x+v.width*.5-20,T),t.moveTo(O+c,P),t.lineTo(v.x+v.width*.5+20,T),t.stroke(),M(t,S,v.x+v.width/2,v.y+18,{background:"rgba(15, 52, 96, 0.4)"}),M(t,h?"Vergence = Accommodation":"Vergence ≠ Accommodation",v.x+v.width/2,v.y+v.height-24,{background:h?"rgba(76, 175, 80, 0.2)":"rgba(255, 107, 107, 0.25)"}),t.restore()};k(b[0],"Natural Vision",i,i,!0),k(b[1],"VR Vision",i,s,!1);const R=b[1].x+18,N=b[1].y+b[1].height*.75,y=b[1].width-36;t.save(),t.fillStyle="rgba(255, 255, 255, 0.08)",t.fillRect(R,N,y,10),t.fillStyle=o;const z=Math.min(1,a/1);t.fillRect(R,N,y*z,10),t.restore(),M(t,n,R+y/2,N+22,{background:"rgba(0, 0, 0, 0.4)",color:o})}}class Wt extends _{ipdInput;nearInput;farInput;eyeReliefInput;calloutEl;constructor(t){super(t),this.ipdInput=this.addSlider({id:"frustum-ipd",label:"IPD (mm)",min:52,max:78,step:1,value:63,unit:"mm"}),this.nearInput=this.addSlider({id:"frustum-near",label:"Near Plane (m)",min:.01,max:.5,step:.01,value:.06,unit:"m"}),this.farInput=this.addSlider({id:"frustum-far",label:"Far Plane (m)",min:.5,max:100,step:.1,value:1.56,unit:"m"}),this.eyeReliefInput=this.addSlider({id:"frustum-eye-relief",label:"Eye Relief (mm)",min:8,max:25,step:1,value:18,unit:"mm"}),this.addReadout({id:"frustum-left",label:"Left Eye L/R",unit:"m"}),this.addReadout({id:"frustum-right",label:"Right Eye L/R",unit:"m"}),this.addReadout({id:"frustum-v",label:"Top/Bottom",unit:"m"}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.calloutEl.textContent="Frustum culling removes objects outside the view; each eye needs a unique asymmetric projection matrix.",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const i=Number(this.ipdInput.value),s=Number(this.nearInput.value),a=Number(this.farInput.value),n=Number(this.eyeReliefInput.value),o=wt({...Z,ipd:i/1e3,eyeRelief:n/1e3}),l=s/o.distEye2Display,d=o.leftForLeftEye*l,m=o.rightForLeftEye*l,p=o.leftForRightEye*l,b=o.rightForRightEye*l,k=s*o.imgHeight/(2*o.distEye2Img),R=-k;this.setReadout("frustum-left",`${d.toFixed(3)}, ${m.toFixed(3)}`),this.setReadout("frustum-right",`${p.toFixed(3)}, ${b.toFixed(3)}`),this.setReadout("frustum-v",`${k.toFixed(3)}, ${R.toFixed(3)}`);const N=18,y=24,z=(this.height-N*2-y)/2,v=this.width-N*2,S=[{x:N,y:N,width:v,height:z},{x:N,y:N+z+y,width:v,height:z}],C=h=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(h.x,h.y,h.width,h.height);const P=-200,c=200,u=0,D=a*1e3*1.1,O=h.width/(c-P),H=h.height/(D-u),f=(X,B)=>({x:h.x+(X-P)*O,y:h.y+h.height-(B-u)*H}),r=-i/2,w=i/2,x=s*1e3,E=a*1e3,L=a/s,T=r+d*1e3,I=r+m*1e3,V=r+d*1e3*L,W=r+m*1e3*L,j=w+p*1e3,A=w+b*1e3,$=w+p*1e3*L,Y=w+b*1e3*L,nt=(X,B,K,J,It,ht)=>{t.save(),t.fillStyle=ht,t.strokeStyle=ht,t.beginPath();const dt=f(X,0);t.moveTo(dt.x,dt.y);const yt=f(B,x),ut=f(K,x),mt=f(It,E),gt=f(J,E);t.lineTo(yt.x,yt.y),t.lineTo(gt.x,gt.y),t.lineTo(mt.x,mt.y),t.lineTo(ut.x,ut.y),t.closePath(),t.globalAlpha=.18,t.fill(),t.globalAlpha=.8,t.stroke(),t.restore()};nt(r,T,I,V,W,g.rayLeft),nt(w,j,A,$,Y,g.rayRight);const ot=Math.max(T,j),lt=Math.min(I,A),Et=Math.max(V,$),Tt=Math.min(W,Y);if(ot<lt){t.save(),t.fillStyle=g.overlap,t.beginPath();const X=f(ot,x),B=f(lt,x),K=f(Tt,E),J=f(Et,E);t.moveTo(X.x,X.y),t.lineTo(B.x,B.y),t.lineTo(K.x,K.y),t.lineTo(J.x,J.y),t.closePath(),t.fill(),t.restore()}const rt=f(P,0),ct=f(c,0);G(t,rt.x,rt.y,ct.x,ct.y,{color:g.axis,dash:[5,6]}),M(t,"Top-down frustum (horizontal)",h.x+140,h.y+18,{background:"rgba(15, 52, 96, 0.4)"}),t.restore()},F=h=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(h.x,h.y,h.width,h.height);const P=-80,c=80,u=0,D=a*1e3*1.1,O=h.width/(c-P),H=h.height/(D-u),f=(I,V)=>({x:h.x+(I-P)*O,y:h.y+h.height-(V-u)*H}),r=s*1e3,w=a*1e3,x=a/s,E=k*1e3,L=E*x,T=[{x:0,y:0},{x:-E,y:r},{x:-L,y:w},{x:L,y:w},{x:E,y:r}];t.save(),t.strokeStyle=g.rayGreen,t.globalAlpha=.8,t.beginPath(),T.forEach((I,V)=>{const W=f(I.x,I.y);V===0?t.moveTo(W.x,W.y):t.lineTo(W.x,W.y)}),t.closePath(),t.stroke(),t.restore(),M(t,"Side view (vertical symmetric)",h.x+140,h.y+18,{background:"rgba(233, 69, 96, 0.25)"}),t.restore()};C(S[0]),F(S[1])}}const Ot=new Map([["thin-lens",e=>new Ct(e)],["light-path",e=>new Dt(e)],["params",e=>new Nt(e)],["frustum",e=>new Wt(e)],["distortion",e=>new Lt(e)],["vac",e=>new Ht(e)]]);function zt(){document.querySelectorAll("[data-panel]").forEach(e=>{const t=e.dataset.panel;if(!t)return;const i=Ot.get(t);i&&i(e)})}function Rt(){const e=window.location.hash;if(!e)return;const t=document.querySelector(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}window.addEventListener("hashchange",Rt);zt();setTimeout(Rt,50);
