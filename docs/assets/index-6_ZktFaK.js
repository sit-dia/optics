(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function s(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=s(a);fetch(a.href,o)}})();const Mt='12px "Space Grotesk", system-ui, sans-serif';function Y(e,t,s,i,a,o={}){const{color:n="#eaeaea",width:l=2,headSize:d=8}=o,m=Math.atan2(a-s,i-t);e.save(),e.strokeStyle=n,e.lineWidth=l,e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.stroke(),e.beginPath(),e.moveTo(i,a),e.lineTo(i-d*Math.cos(m-Math.PI/6),a-d*Math.sin(m-Math.PI/6)),e.lineTo(i-d*Math.cos(m+Math.PI/6),a-d*Math.sin(m+Math.PI/6)),e.closePath(),e.fillStyle=n,e.fill(),e.restore()}function tt(e,t,s,i,a={}){const{color:o="#ffd700",width:n=2}=a;e.save(),e.strokeStyle=o,e.lineWidth=n,e.beginPath(),e.moveTo(t,s-i/2),e.lineTo(t,s+i/2),e.stroke(),Y(e,t,s-i/2,t,s-i/2-12,{color:o,width:n,headSize:6}),Y(e,t,s+i/2,t,s+i/2+12,{color:o,width:n,headSize:6}),e.restore()}function $(e,t,s,i,a,o={}){const{color:n="#888888",width:l=1,dash:d=[6,6]}=o;e.save(),e.strokeStyle=n,e.lineWidth=l,e.setLineDash(d),e.beginPath(),e.moveTo(t,s),e.lineTo(i,a),e.stroke(),e.restore()}function U(e,t,s,i,a=0){e.save(),e.translate(t,s),e.rotate(a),e.strokeStyle="#eaeaea",e.lineWidth=2,e.beginPath(),e.arc(0,0,i,0,Math.PI*2),e.stroke(),e.fillStyle="#11121d",e.beginPath(),e.arc(i*.2,0,i*.35,0,Math.PI*2),e.fill(),e.restore()}function st(e,t,s,i,a){e.save(),e.fillStyle="rgba(179, 157, 219, 0.35)",e.strokeStyle="#b39ddb",e.lineWidth=2,e.fillRect(t,s,i,a),e.strokeRect(t,s,i,a),e.restore()}function pt(e,t,s,i,a,o,n=12){e.save(),e.strokeStyle="#888888",e.lineWidth=1;const l=i-t,d=a-s,m=Math.hypot(l,d);if(m===0)return;const p=-d/m,b=l/m,k=p*n,E=b*n;e.beginPath(),e.moveTo(t+k,s+E),e.lineTo(i+k,a+E),e.stroke(),e.beginPath(),e.moveTo(t+k,s+E),e.lineTo(t+k+p*6,s+E+b*6),e.stroke(),e.beginPath(),e.moveTo(i+k,a+E),e.lineTo(i+k+p*6,a+E+b*6),e.stroke(),M(e,o,(t+i)/2+k,(s+a)/2+E),e.restore()}function at(e,t,s={}){const{color:i="#4da6ff",width:a=2,dash:o,glow:n}=s;e.save(),e.strokeStyle=i,e.lineWidth=a,o&&e.setLineDash(o),n&&(e.shadowColor=i,e.shadowBlur=8),e.beginPath(),t.forEach((l,d)=>{d===0?e.moveTo(l.x,l.y):e.lineTo(l.x,l.y)}),e.stroke(),e.restore()}function ft(e,t,s,i){const{width:a,height:o}=e.canvas;e.save(),e.strokeStyle="#444444",e.lineWidth=1;for(let n=0;n<=t;n+=1){const l=n/t*o;e.beginPath();for(let d=0;d<=s;d+=1){const m=d/s*a,p=i?i(m,l):{x:m,y:l};d===0?e.moveTo(p.x,p.y):e.lineTo(p.x,p.y)}e.stroke()}for(let n=0;n<=s;n+=1){const l=n/s*a;e.beginPath();for(let d=0;d<=t;d+=1){const m=d/t*o,p=i?i(l,m):{x:l,y:m};d===0?e.moveTo(p.x,p.y):e.lineTo(p.x,p.y)}e.stroke()}e.restore()}function M(e,t,s,i,a={}){const{color:o="#eaeaea",background:n="rgba(0, 0, 0, 0.45)",padding:l=4,font:d=Mt}=a;e.save(),e.font=d;const p=e.measureText(t).width+l*2,b=16+l;e.fillStyle=n,e.fillRect(s-p/2,i-b/2,p,b),e.fillStyle=o,e.textAlign="center",e.textBaseline="middle",e.fillText(t,s,i+1),e.restore()}const Z={f:.043,distLens2Display:.042,eyeRelief:.018,ipd:.065,displayWidth:.12096,displayHeight:.068},Q={k1:.34,k2:.55},g={accent:"#e94560",text:"#eaeaea",rayLeft:"#4da6ff",rayRight:"#ff6b6b",rayGreen:"#4caf50",rayYellow:"#ffc107",virtualImage:"#a855f7",overlap:"rgba(128, 0, 255, 0.15)",lens:"#ffd700",axis:"#555555"},kt=.3,St=.5;function vt(e,t){return 1/(1/e-1/t)}function Lt(e,t){return-e/t}function bt(e){return!Number.isFinite(e)||Math.abs(e)>1e6?"infinity":e>0?"real":"virtual"}const et=180/Math.PI;function wt(e){const{f:t,distLens2Display:s,eyeRelief:i,ipd:a,displayWidth:o,displayHeight:n}=e,l=t/(t-s),d=Math.abs(1/(1/t-1/s)),m=d+i,p=i+s,b=n*l,k=2*Math.atan(b/2/m)*et,E=Math.atan(l*a/2/m)*et,N=Math.atan(l*(o-a)/2/m)*et,y=E+N,A=i+s,v=A*b/(2*m),S=-v,C=l*a/2,P=l*(o-a)/2,h=p*C/m,L=-(p*P)/m,c=p*P/m,u=-(p*C)/m;return{distEye2Display:p,magnification:l,imgHeight:b,distLens2Img:d,distEye2Img:m,near:A,fovVertical:k,fovHNasal:E,fovHTemporal:N,fovHorizontal:y,top:v,bottom:S,imgWidthNasal:C,imgWidthTemporal:P,leftForLeftEye:L,rightForLeftEye:h,leftForRightEye:u,rightForRightEye:c}}function it(e,t,s,i,a,o){const n=e-s,l=t-i,d=n*n+l*l,m=1+a*d+o*d*d;return{x:s+n*m,y:i+l*m}}function xt(e){return 1/e}function Pt(e,t){return Math.abs(xt(e)-xt(t))}class _{container;canvas;ctx;controlsEl;readoutsEl;width=0;height=0;resizeObserver;rafId=null;resizeTimer=null;constructor(t){this.container=t;const s=t.querySelector("[data-canvas]"),i=t.querySelector("[data-controls]"),a=t.querySelector("[data-readouts]");if(!s||!i||!a)throw new Error("Panel container missing required elements");this.controlsEl=i,this.readoutsEl=a,this.canvas=document.createElement("canvas"),this.canvas.setAttribute("aria-label","Optics visualization"),s.appendChild(this.canvas);const o=this.canvas.getContext("2d");if(!o)throw new Error("Canvas context unavailable");this.ctx=o,this.resizeObserver=new ResizeObserver(()=>this.scheduleResize()),this.resizeObserver.observe(s),this.resize()}scheduleResize(){this.resizeTimer!==null&&window.clearTimeout(this.resizeTimer),this.resizeTimer=window.setTimeout(()=>{this.resizeTimer=null,this.resize()},120)}resize(){const t=this.canvas.parentElement;if(!t)return;const s=t.getBoundingClientRect(),i=Math.max(0,Math.floor(s.width)),a=Math.max(0,Math.floor(s.height));if(i===this.width&&a===this.height)return;const o=window.devicePixelRatio||1;this.canvas.width=Math.floor(i*o),this.canvas.height=Math.floor(a*o),this.width=i,this.height=a,this.ctx.setTransform(o,0,0,o,0,0),this.requestDraw()}requestDraw(){this.rafId!==null&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>{this.rafId=null,this.render()})}addSlider(t){const s=document.createElement("div");s.className="control-row";const i=document.createElement("label");i.htmlFor=t.id,i.textContent=t.label;const a=document.createElement("div");a.className="value";const o=document.createElement("input");o.id=t.id,o.type="range",o.min=String(t.min),o.max=String(t.max),o.step=String(t.step),o.value=String(t.value);const n=l=>{const d=Number(l);a.textContent=`${d}${t.unit??""}`,t.onChange?.(d),this.requestDraw()};return o.addEventListener("input",()=>n(o.value)),n(o.value),s.appendChild(i),s.appendChild(o),s.appendChild(a),this.controlsEl.appendChild(s),o}addReadout(t){const s=document.createElement("div");s.className="readout",s.dataset.readout=t.id;const i=document.createElement("span");i.textContent=t.label;const a=document.createElement("span");return a.textContent=`--${t.unit??""}`,s.appendChild(i),s.appendChild(a),this.readoutsEl.appendChild(s),a}setReadout(t,s){const i=this.readoutsEl.querySelector(`[data-readout="${t}"] span:last-child`);i&&(i.textContent=s)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}render(){this.clear();const{width:t,height:s}=this;this.ctx.fillStyle="#101424",this.ctx.fillRect(0,0,t,s),this.ctx.fillStyle="#eaeaea",this.ctx.font='14px "Space Grotesk", system-ui, sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Panel rendering...",t/2,s/2)}dispose(){this.resizeObserver.disconnect(),this.resizeTimer!==null&&(window.clearTimeout(this.resizeTimer),this.resizeTimer=null)}}class Ft extends _{k1Input;k2Input;gridInput;preToggle;constructor(t){super(t),this.k1Input=this.addSlider({id:"distortion-k1",label:"k1",min:-1,max:1,step:.01,value:Q.k1}),this.k2Input=this.addSlider({id:"distortion-k2",label:"k2",min:-1,max:1,step:.01,value:Q.k2}),this.gridInput=this.addSlider({id:"distortion-grid",label:"Grid Density",min:4,max:20,step:1,value:8});const s=document.createElement("div");s.className="control-row";const i=document.createElement("label");i.htmlFor="distortion-pre-toggle",i.textContent="Pre-correction",this.preToggle=document.createElement("input"),this.preToggle.id="distortion-pre-toggle",this.preToggle.name="distortion-pre-toggle",this.preToggle.type="checkbox",this.preToggle.checked=!1,this.preToggle.addEventListener("change",()=>this.requestDraw()),s.appendChild(i),s.appendChild(this.preToggle),this.controlsEl.appendChild(s)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const s=Number(this.k1Input.value),i=Number(this.k2Input.value),a=Number(this.gridInput.value),o=16,n=18,l=(this.height-o*2-n*2)/3,d=this.width-o*2,m=[{x:o,y:o,width:d,height:l},{x:o,y:o+l+n,width:d,height:l},{x:o,y:o+(l+n)*2,width:d,height:l}],p=(c,u,D,O=0,H=0)=>{t.save(),t.beginPath(),t.rect(c.x,c.y,c.width,c.height),t.clip(),t.translate(c.x,c.y),t.scale(c.width/t.canvas.width,c.height/t.canvas.height);const f=t.canvas.width,r=t.canvas.height,w=f/2,x=r/2,T=Math.min(f,r)/2;ft(t,u,D,O!==0||H!==0?(R,I)=>{const z=(R-w)/T,W=(I-x)/T,V=it(z,W,0,0,O,H);return{x:w+V.x*T,y:x+V.y*T}}:void 0),t.restore()},b=m[0],k=m[1],E=m[2],N=(b.width-n)/2,y={x:b.x,y:b.y,width:N,height:b.height},A={x:b.x+N+n,y:b.y,width:N,height:b.height};p(y,a,a,Q.k1,Q.k2),p(A,a,a,-.34,-.55),M(t,"Barrel distortion",y.x+90,y.y+18,{background:"rgba(233, 69, 96, 0.25)"}),M(t,"Pincushion distortion",A.x+100,A.y+18,{background:"rgba(15, 52, 96, 0.4)"});const v=12,S=4,C=(k.width-v*(S-1))/S,P=k.height,h=Array.from({length:S},(c,u)=>({x:k.x+u*(C+v),y:k.y,width:C,height:P}));p(h[0],8,8),M(t,"Original",h[0].x+40,h[0].y+18,{background:"rgba(255, 255, 255, 0.08)"}),p(h[1],8,8,-s,-i),M(t,"Pre-distort",h[1].x+46,h[1].y+18,{background:"rgba(15, 52, 96, 0.4)"}),p(h[2],8,8,s,i),M(t,"Lens barrel",h[2].x+46,h[2].y+18,{background:"rgba(233, 69, 96, 0.25)"}),p(h[3],8,8,0,0),M(t,"Straight",h[3].x+42,h[3].y+18,{background:"rgba(76, 175, 80, 0.2)"});for(let c=0;c<h.length-1;c+=1){const u=h[c],D=h[c+1];Y(t,u.x+u.width+4,u.y+u.height/2,D.x-4,D.y+D.height/2,{color:"#eaeaea",width:1.5,headSize:6})}const L=this.preToggle.checked?"Pre-correction ON → canceling barrel":"Interactive distortion playground";if(M(t,L,E.x+120,E.y+18,{background:"rgba(255, 255, 255, 0.08)"}),this.preToggle.checked){const c=(u,D)=>{const O=t.canvas.width/2,H=t.canvas.height/2,f=Math.min(t.canvas.width,t.canvas.height)/2,r=(u-O)/f,w=(D-H)/f,x=it(r,w,0,0,-s,-i),T=it(x.x,x.y,0,0,s,i);return{x:O+T.x*f,y:H+T.y*f}};t.save(),t.beginPath(),t.rect(E.x,E.y,E.width,E.height),t.clip(),t.translate(E.x,E.y),t.scale(E.width/t.canvas.width,E.height/t.canvas.height),ft(t,a,a,c),t.restore()}else p(E,a,a,s,i)}}class Nt extends _{ipdInput;eyeReliefInput;fInput;doInput;fovToggle;warningEl;constructor(t){super(t),this.ipdInput=this.addSlider({id:"params-ipd",label:"IPD (mm)",min:52,max:78,step:1,value:63,unit:"mm"}),this.eyeReliefInput=this.addSlider({id:"params-eye-relief",label:"Eye Relief (mm)",min:8,max:25,step:1,value:18,unit:"mm"}),this.fInput=this.addSlider({id:"params-f",label:"Focal Length (mm)",min:30,max:60,step:1,value:43,unit:"mm"}),this.doInput=this.addSlider({id:"params-do",label:"Lens to Display (mm)",min:30,max:55,step:1,value:42,unit:"mm"});const s=document.createElement("div");s.className="control-row";const i=document.createElement("label");i.htmlFor="params-fov-toggle",i.textContent="Show FOV breakdown",this.fovToggle=document.createElement("input"),this.fovToggle.id="params-fov-toggle",this.fovToggle.name="params-fov-toggle",this.fovToggle.type="checkbox",this.fovToggle.checked=!0,this.fovToggle.addEventListener("change",()=>this.requestDraw()),s.appendChild(i),s.appendChild(this.fovToggle),this.controlsEl.appendChild(s),this.addReadout({id:"params-mag",label:"Magnification",unit:"x"}),this.addReadout({id:"params-img",label:"Virtual Image Dist",unit:"mm"}),this.addReadout({id:"params-eye-img",label:"Eye-to-Image",unit:"mm"}),this.addReadout({id:"params-fov-v",label:"FOV Vertical",unit:"deg"}),this.addReadout({id:"params-fov-nasal",label:"FOV H-Nasal",unit:"deg"}),this.addReadout({id:"params-fov-temporal",label:"FOV H-Temporal",unit:"deg"}),this.addReadout({id:"params-fov",label:"FOV H-Total",unit:"deg"}),this.addReadout({id:"params-near",label:"Near Plane",unit:"mm"}),this.warningEl=document.createElement("div"),this.warningEl.className="callout",this.warningEl.textContent="Extreme IPD values can reduce comfort.",this.controlsEl.appendChild(this.warningEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const s=Number(this.ipdInput.value),i=Number(this.eyeReliefInput.value),a=Number(this.fInput.value),o=Number(this.doInput.value),n=wt({...Z,ipd:s/1e3,eyeRelief:i/1e3,f:a/1e3,distLens2Display:o/1e3});this.setReadout("params-mag",n.magnification.toFixed(2)),this.setReadout("params-img",(n.distLens2Img*1e3).toFixed(0)),this.setReadout("params-eye-img",(n.distEye2Img*1e3).toFixed(0)),this.setReadout("params-fov-v",n.fovVertical.toFixed(1)),this.setReadout("params-fov-nasal",n.fovHNasal.toFixed(1)),this.setReadout("params-fov-temporal",n.fovHTemporal.toFixed(1)),this.setReadout("params-fov",n.fovHorizontal.toFixed(1)),this.setReadout("params-near",(n.near*1e3).toFixed(0));const l=s<56||s>72;this.warningEl.style.display=l?"block":"none";const d=20,m=-120,p=120,b=-140,k=80,E=(this.width-d*2)/(p-m),N=(this.height-d*2)/(k-b),y=(V,j)=>({x:d+(V-m)*E,y:this.height-d-(j-b)*N}),A=(V,j,G)=>{at(t,V.map(q=>y(q.x,q.y)),{color:j,dash:G})},v=Z.displayWidth*1e3,S=14,C=-o,P=i,h=0,L=y(-v/2,C+S/2);st(t,L.x,L.y,v*E,S*N),M(t,"Display",L.x+42,L.y-12,{background:"rgba(179, 157, 219, 0.2)"});const c=-s/2,u=s/2,D=y(c,P),O=y(u,P);U(t,D.x,D.y,12,0),U(t,O.x,O.y,12,0);const H=y(c,h),f=y(u,h);tt(t,H.x,H.y,32,{color:g.lens}),tt(t,f.x,f.y,32,{color:g.lens});const r=i+n.distLens2Img*1e3,w=n.magnification*Z.displayWidth*1e3,x=y(-w/2,r+8);$(t,x.x,x.y,x.x+w*E,x.y,{color:g.virtualImage,dash:[6,6],width:1.5}),M(t,"Virtual image",x.x+50,x.y-14,{background:"rgba(168, 85, 247, 0.25)"});const T=n.imgWidthNasal*1e3,F=n.imgWidthTemporal*1e3,R={x:c+T,y:r},I={x:c-F,y:r},z={x:u-T,y:r},W={x:u+F,y:r};if(A([{x:c,y:P},{x:R.x,y:R.y}],g.rayLeft),A([{x:c,y:P},{x:I.x,y:I.y}],g.rayLeft),A([{x:u,y:P},{x:z.x,y:z.y}],g.rayRight),A([{x:u,y:P},{x:W.x,y:W.y}],g.rayRight),this.fovToggle.checked){if(R.x<z.x){const V=y(c,P),j=y(u,P),G=y(R.x,R.y),q=y(z.x,z.y);t.save(),t.fillStyle=g.overlap,t.beginPath(),t.moveTo(V.x,V.y),t.lineTo(j.x,j.y),t.lineTo(q.x,q.y),t.lineTo(G.x,G.y),t.closePath(),t.fill(),t.restore()}M(t,"Nasal",y(R.x,R.y).x+12,y(R.x,R.y).y-12,{background:"rgba(255, 255, 255, 0.08)"}),M(t,"Temporal",y(I.x,I.y).x-12,y(I.x,I.y).y-12,{background:"rgba(255, 255, 255, 0.08)"})}pt(t,y(c,P).x,y(c,P).y+22,y(u,P).x,y(u,P).y+22,`IPD ${s.toFixed(0)}mm`,10),pt(t,y(u+18,h).x,y(u+18,h).y,y(u+18,P).x,y(u+18,P).y,`Eye relief ${i.toFixed(0)}mm`,8),M(t,"Top-down HMD cross-section",y(0,k-10).x,28,{background:"rgba(15, 52, 96, 0.4)"})}}class Dt extends _{fInput;doInput;calloutEl;constructor(t){super(t),this.fInput=this.addSlider({id:"light-path-f",label:"Focal Length (mm)",min:20,max:100,step:1,value:43,unit:"mm"}),this.doInput=this.addSlider({id:"light-path-do",label:"Object Distance (mm)",min:10,max:120,step:1,value:42,unit:"mm"}),this.addReadout({id:"light-path-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"light-path-regime",label:"Regime",unit:""}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const s=Number(this.fInput.value),i=Number(this.doInput.value),a=vt(s,i),o=Math.abs(i-s)<1,n=o?Number.POSITIVE_INFINITY:a,l=o?"infinity":bt(n),d=l==="infinity"?"∞":a.toFixed(0);this.setReadout("light-path-di",d),this.setReadout("light-path-regime",i<s?"HMD (virtual image)":"Projection (real image)"),this.calloutEl.textContent=i<s?"Display inside focal length → virtual, magnified image (HMD regime).":"Object beyond focal length → real inverted image (projection regime).";const m=18,p=24,b=(this.height-m*2-p)/2,k=this.width-m*2,E=[{x:m,y:m,width:k,height:b},{x:m,y:m+b+p,width:k,height:b}],N=(y,A)=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(y.x,y.y,y.width,y.height);const v=-130,S=170,C=-80,P=80,h=y.width/(S-v),L=y.height/(P-C),c=(f,r)=>({x:y.x+(f-v)*h,y:y.y+y.height-(r-C)*L}),u=(f,r,w)=>{at(t,f.map(x=>c(x.x,x.y)),{color:w??g.rayLeft,dash:r})},D=c(v,0),O=c(S,0);$(t,D.x,D.y,O.x,O.y,{color:g.axis,dash:[6,6]});const H=c(0,0);if(tt(t,H.x,H.y,100,{color:g.lens}),A==="projection"){const r=c(-i,0),w=c(-i,28);if(Y(t,r.x,r.y,w.x,w.y,{color:g.accent}),M(t,"Light source",w.x,w.y-12,{background:"rgba(233, 69, 96, 0.2)"}),l==="real"){const z=-28*(a/i),W=c(a,0),V=c(a,z);Y(t,W.x,W.y,V.x,V.y,{color:g.rayGreen}),st(t,W.x-6,W.y-40,12,80),M(t,"Screen",W.x+26,W.y-30,{background:"rgba(179, 157, 219, 0.2)"})}else M(t,"No real focus",H.x+60,H.y-40,{background:"rgba(255, 255, 255, 0.08)"});const x={x:-i,y:28},T=-28/s,F={x:S,y:x.y+T*S};u([{x:x.x,y:x.y},{x:0,y:x.y},F],void 0,g.rayLeft);const R=(0-x.y)/(0-x.x),I={x:S,y:R*S};u([{x:x.x,y:x.y},{x:0,y:0},I],void 0,g.rayYellow),l==="virtual"&&u([{x:0,y:x.y},{x:a,y:x.y*(-a/i)}],[6,6],g.virtualImage),M(t,"Projection path",y.x+80,y.y+18,{background:"rgba(15, 52, 96, 0.4)"})}else{const r=c(-i,0);st(t,r.x-8,r.y-30,16,60),M(t,"Display",r.x-32,r.y-38,{background:"rgba(179, 157, 219, 0.2)"});const w=c(90,0);U(t,w.x,w.y,16,0),M(t,"Eye",w.x+28,w.y-16,{background:"rgba(255, 255, 255, 0.08)"});const x={x:-i,y:30},T={x:-i,y:-30},F={x:90};if(u([{x:x.x,y:x.y},{x:0,y:x.y},{x:F.x,y:x.y*.3}],void 0,g.rayLeft),u([{x:T.x,y:T.y},{x:0,y:T.y},{x:F.x,y:T.y*.3}],void 0,g.rayGreen),l==="virtual"){const R={x:a,y:0};u([{x:0,y:x.y},R],[6,6],g.virtualImage),u([{x:0,y:T.y},R],[6,6],g.virtualImage),M(t,"Virtual image",c(a,0).x-10,y.y+24,{background:"rgba(168, 85, 247, 0.25)"})}M(t,"HMD path",y.x+60,y.y+18,{background:"rgba(233, 69, 96, 0.25)"})}t.restore()};N(E[0],"projection"),N(E[1],"hmd")}}class Ct extends _{fInput;doInput;calloutEl;constructor(t){super(t),this.fInput=this.addSlider({id:"thin-lens-f",label:"Focal Length (mm)",min:10,max:200,step:1,value:40,unit:"mm"}),this.doInput=this.addSlider({id:"thin-lens-do",label:"Object Distance (mm)",min:5,max:500,step:1,value:80,unit:"mm"}),this.addReadout({id:"thin-lens-di",label:"Image Distance",unit:"mm"}),this.addReadout({id:"thin-lens-m",label:"Magnification",unit:"x"}),this.addReadout({id:"thin-lens-eq",label:"Lens Equation",unit:""}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.calloutEl.textContent="This is how HMD lenses work — display closer than f creates a magnified virtual image.",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const s=Number(this.fInput.value),i=Number(this.doInput.value),a=vt(s,i),o=Math.abs(i-s)<1,n=o?Number.POSITIVE_INFINITY:a,l=o?"infinity":bt(n),d=Lt(a,i),m=l==="infinity"?"∞":a.toFixed(0),p=Number.isFinite(d)?d.toFixed(2):"--";this.setReadout("thin-lens-di",m),this.setReadout("thin-lens-m",p),this.setReadout("thin-lens-eq",`1/${s.toFixed(0)} = 1/${i.toFixed(0)} + 1/${m}`),this.calloutEl.style.display=i<s?"block":"none";const b=24,k=-220,E=220,N=-120,y=120,A=(this.width-b*2)/(E-k),v=(this.height-b*2)/(y-N),S=(T,F)=>({x:b+(T-k)*A,y:this.height-b-(F-N)*v}),C=(T,F,R)=>{at(t,T.map(I=>S(I.x,I.y)),{color:R??g.rayLeft,dash:F})},P=S(k,0),h=S(E,0);$(t,P.x,P.y,h.x,h.y,{color:g.axis,dash:[6,6]});const L=S(0,0);tt(t,L.x,L.y,140,{color:g.lens});const c=S(-s,0),u=S(s,0);M(t,"F",c.x,c.y-16,{color:g.text}),M(t,"F'",u.x,u.y-16,{color:g.text}),$(t,c.x,c.y-6,c.x,c.y+6,{color:g.axis,dash:[3,4]}),$(t,u.x,u.y-6,u.x,u.y+6,{color:g.axis,dash:[3,4]});const D=40,O=S(-i,0),H=S(-i,D);Y(t,O.x,O.y,H.x,H.y,{color:g.accent,width:2.5}),M(t,"Object",H.x,H.y-14,{background:"rgba(233, 69, 96, 0.2)"});const f={x:0,y:0},r={x:-i,y:D},w=E;if(l!=="infinity"){const T=D*d,F=a,R=S(F,0),I=S(F,T);l==="virtual"?($(t,R.x,R.y,I.x,I.y,{color:g.virtualImage,dash:[6,6],width:2}),Y(t,R.x,R.y,I.x,I.y,{color:g.virtualImage,width:2,headSize:6})):Y(t,R.x,R.y,I.x,I.y,{color:g.rayGreen,width:2.5}),M(t,l==="virtual"?"Virtual Image":"Real Image",I.x,I.y-16,{background:l==="virtual"?"rgba(168, 85, 247, 0.25)":"rgba(76, 175, 80, 0.2)"})}else M(t,"Image at infinity",L.x+90,L.y-40,{background:"rgba(255, 255, 255, 0.08)"});if(l==="infinity")C([{x:r.x,y:r.y},{x:f.x,y:r.y},{x:w,y:r.y}],void 0,g.rayLeft),C([{x:r.x,y:r.y},{x:f.x,y:0},{x:w,y:r.y/i*w*-1}],void 0,g.rayYellow),C([{x:r.x,y:r.y},{x:0,y:r.y},{x:w,y:r.y}],void 0,g.rayGreen);else{const T=-40/s,F={x:w,y:r.y+T*w};C([{x:r.x,y:r.y},{x:0,y:r.y},{x:F.x,y:F.y}],void 0,g.rayLeft);const R=(f.y-r.y)/(f.x-r.x),I={x:w,y:f.y+R*w};C([{x:r.x,y:r.y},{x:f.x,y:f.y},{x:I.x,y:I.y}],void 0,g.rayYellow);const z=(0-r.y)/(-s-r.x),W=r.y+z*(0-r.x),V={x:w,y:W};if(C([{x:r.x,y:r.y},{x:0,y:W},{x:V.x,y:V.y}],void 0,g.rayGreen),l==="virtual"){const j={x:a,y:D*d};C([{x:0,y:r.y},j],[6,6],g.virtualImage),C([{x:0,y:f.y},j],[6,6],g.virtualImage),C([{x:0,y:W},j],[6,6],g.virtualImage)}}const x=l==="infinity"?"Object at f → image at infinity":i<s?"HMD regime: virtual image":"Projector regime: real image";M(t,x,L.x,L.y+90,{background:i<s?"rgba(233, 69, 96, 0.2)":"rgba(255, 255, 255, 0.08)"})}}class Ht extends _{depthInput;displayReadout;infoEl;constructor(t){super(t),this.depthInput=this.addSlider({id:"vac-depth",label:"Virtual Object Depth (m)",min:.3,max:10,step:.1,value:2,unit:"m"}),this.addReadout({id:"vac-mismatch",label:"Mismatch",unit:"D"}),this.displayReadout=this.addReadout({id:"vac-display",label:"Display Distance",unit:"m"}),this.infoEl=document.createElement("div"),this.infoEl.className="callout",this.infoEl.innerHTML="Industry solutions: varifocal displays, light field displays, foveated rendering.",this.controlsEl.appendChild(this.infoEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const s=Number(this.depthInput.value),i=1.8,a=Pt(i,s);this.setReadout("vac-mismatch",a.toFixed(2)),this.displayReadout.textContent=i.toFixed(1);let o="Comfortable",n=g.rayGreen;a>St?(o="Eye strain likely",n=g.rayRight):a>kt&&(o="Mild discomfort",n=g.rayYellow);const l=18,d=20,m=(this.width-l*2-d)/2,p=this.height-l*2,b=[{x:l,y:l,width:m,height:p},{x:l+m+d,y:l,width:m,height:p}],k=(v,S,C,P,h)=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(v.x,v.y,v.width,v.height);const L=v.y+v.height*.55,c=v.width*.18,u=v.width*.08,D=v.x+v.width*.4,O=v.x+v.width*.6,f=Math.atan(.065/2/C),r=-f,w=f;U(t,D-c,L,u,r),U(t,O+c,L,u,w);const x=Math.max(.2,Math.min(1,1-(P-.3)/9.7)),T=u*(.4+.4*x),F=u*(.9+.2*x);t.fillStyle=h?"rgba(76, 175, 80, 0.4)":"rgba(255, 107, 107, 0.3)",t.beginPath(),t.ellipse(D-c+u*.3,L,T,F,0,0,Math.PI*2),t.fill(),t.beginPath(),t.ellipse(O+c-u*.3,L,T,F,0,0,Math.PI*2),t.fill();const R=v.y+v.height*.2;t.strokeStyle=h?g.rayGreen:g.rayRight,t.lineWidth=2,t.beginPath(),t.moveTo(D-c,L),t.lineTo(v.x+v.width*.5-20,R),t.moveTo(O+c,L),t.lineTo(v.x+v.width*.5+20,R),t.stroke(),M(t,S,v.x+v.width/2,v.y+18,{background:"rgba(15, 52, 96, 0.4)"}),M(t,h?"Vergence = Accommodation":"Vergence ≠ Accommodation",v.x+v.width/2,v.y+v.height-24,{background:h?"rgba(76, 175, 80, 0.2)":"rgba(255, 107, 107, 0.25)"}),t.restore()};k(b[0],"Natural Vision",s,s,!0),k(b[1],"VR Vision",s,i,!1);const E=b[1].x+18,N=b[1].y+b[1].height*.75,y=b[1].width-36;t.save(),t.fillStyle="rgba(255, 255, 255, 0.08)",t.fillRect(E,N,y,10),t.fillStyle=n;const A=Math.min(1,a/1);t.fillRect(E,N,y*A,10),t.restore(),M(t,o,E+y/2,N+22,{background:"rgba(0, 0, 0, 0.4)",color:n})}}class Wt extends _{ipdInput;nearInput;farInput;eyeReliefInput;calloutEl;constructor(t){super(t),this.ipdInput=this.addSlider({id:"frustum-ipd",label:"IPD (mm)",min:52,max:78,step:1,value:63,unit:"mm"}),this.nearInput=this.addSlider({id:"frustum-near",label:"Near Plane (m)",min:.01,max:.5,step:.01,value:.06,unit:"m"}),this.farInput=this.addSlider({id:"frustum-far",label:"Far Plane (m)",min:.5,max:100,step:.1,value:1.56,unit:"m"}),this.eyeReliefInput=this.addSlider({id:"frustum-eye-relief",label:"Eye Relief (mm)",min:8,max:25,step:1,value:18,unit:"mm"}),this.addReadout({id:"frustum-left",label:"Left Eye L/R",unit:"m"}),this.addReadout({id:"frustum-right",label:"Right Eye L/R",unit:"m"}),this.addReadout({id:"frustum-v",label:"Top/Bottom",unit:"m"}),this.calloutEl=document.createElement("div"),this.calloutEl.className="callout",this.calloutEl.textContent="Frustum culling removes objects outside the view; each eye needs a unique asymmetric projection matrix.",this.controlsEl.appendChild(this.calloutEl)}render(){this.clear();const t=this.ctx;t.fillStyle="#0f1324",t.fillRect(0,0,this.width,this.height);const s=Number(this.ipdInput.value),i=Number(this.nearInput.value),a=Number(this.farInput.value),o=Number(this.eyeReliefInput.value),n=wt({...Z,ipd:s/1e3,eyeRelief:o/1e3}),l=i/n.distEye2Display,d=n.leftForLeftEye*l,m=n.rightForLeftEye*l,p=n.leftForRightEye*l,b=n.rightForRightEye*l,k=i*n.imgHeight/(2*n.distEye2Img),E=-k;this.setReadout("frustum-left",`${d.toFixed(3)}, ${m.toFixed(3)}`),this.setReadout("frustum-right",`${p.toFixed(3)}, ${b.toFixed(3)}`),this.setReadout("frustum-v",`${k.toFixed(3)}, ${E.toFixed(3)}`);const N=18,y=24,A=(this.height-N*2-y)/2,v=this.width-N*2,S=[{x:N,y:N,width:v,height:A},{x:N,y:N+A+y,width:v,height:A}],C=h=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(h.x,h.y,h.width,h.height);const L=-200,c=200,u=0,D=a*1e3*1.1,O=h.width/(c-L),H=h.height/(D-u),f=(X,B)=>({x:h.x+(X-L)*O,y:h.y+h.height-(B-u)*H}),r=-s/2,w=s/2,x=i*1e3,T=a*1e3,F=a/i,R=r+d*1e3,I=r+m*1e3,z=r+d*1e3*F,W=r+m*1e3*F,V=w+p*1e3,j=w+b*1e3,G=w+p*1e3*F,q=w+b*1e3*F,ot=(X,B,K,J,It,ht)=>{t.save(),t.fillStyle=ht,t.strokeStyle=ht,t.beginPath();const dt=f(X,0);t.moveTo(dt.x,dt.y);const yt=f(B,x),ut=f(K,x),mt=f(It,T),gt=f(J,T);t.lineTo(yt.x,yt.y),t.lineTo(gt.x,gt.y),t.lineTo(mt.x,mt.y),t.lineTo(ut.x,ut.y),t.closePath(),t.globalAlpha=.18,t.fill(),t.globalAlpha=.8,t.stroke(),t.restore()};ot(r,R,I,z,W,g.rayLeft),ot(w,V,j,G,q,g.rayRight);const nt=Math.max(R,V),lt=Math.min(I,j),Tt=Math.max(z,G),Rt=Math.min(W,q);if(nt<lt){t.save(),t.fillStyle=g.overlap,t.beginPath();const X=f(nt,x),B=f(lt,x),K=f(Rt,T),J=f(Tt,T);t.moveTo(X.x,X.y),t.lineTo(B.x,B.y),t.lineTo(K.x,K.y),t.lineTo(J.x,J.y),t.closePath(),t.fill(),t.restore()}const rt=f(L,0),ct=f(c,0);$(t,rt.x,rt.y,ct.x,ct.y,{color:g.axis,dash:[5,6]}),M(t,"Top-down frustum (horizontal)",h.x+140,h.y+18,{background:"rgba(15, 52, 96, 0.4)"}),t.restore()},P=h=>{t.save(),t.strokeStyle="rgba(255, 255, 255, 0.08)",t.lineWidth=1,t.strokeRect(h.x,h.y,h.width,h.height);const L=-80,c=80,u=0,D=a*1e3*1.1,O=h.width/(c-L),H=h.height/(D-u),f=(I,z)=>({x:h.x+(I-L)*O,y:h.y+h.height-(z-u)*H}),r=i*1e3,w=a*1e3,x=a/i,T=k*1e3,F=T*x,R=[{x:0,y:0},{x:-T,y:r},{x:-F,y:w},{x:F,y:w},{x:T,y:r}];t.save(),t.strokeStyle=g.rayGreen,t.globalAlpha=.8,t.beginPath(),R.forEach((I,z)=>{const W=f(I.x,I.y);z===0?t.moveTo(W.x,W.y):t.lineTo(W.x,W.y)}),t.closePath(),t.stroke(),t.restore(),M(t,"Side view (vertical symmetric)",h.x+140,h.y+18,{background:"rgba(233, 69, 96, 0.25)"}),t.restore()};C(S[0]),P(S[1])}}const Ot=new Map([["thin-lens",e=>new Ct(e)],["light-path",e=>new Dt(e)],["params",e=>new Nt(e)],["frustum",e=>new Wt(e)],["distortion",e=>new Ft(e)],["vac",e=>new Ht(e)]]),At=["thin-lens","light-path","params","frustum","distortion","vac"];function zt(){document.querySelectorAll("[data-panel]").forEach(e=>{const t=e.dataset.panel;if(!t)return;const s=Ot.get(t);s&&s(e)})}function Et(){const e=window.location.hash;if(!e)return;const t=document.querySelector(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function Vt(){const e=document.querySelectorAll(".sidebar-nav a"),t=document.querySelectorAll('.site-nav a[href^="#"]'),s=a=>{e.forEach(o=>{o.classList.toggle("active",o.getAttribute("data-sidebar")===a)}),t.forEach(o=>{const n=o.getAttribute("href");o.classList.toggle("active",n===`#${a}`)})},i=new IntersectionObserver(a=>{for(const o of a)o.isIntersecting&&s(o.target.id)},{rootMargin:"-20% 0px -60% 0px",threshold:0});At.forEach(a=>{const o=document.getElementById(a);o&&i.observe(o)})}window.addEventListener("hashchange",Et);zt();Vt();setTimeout(Et,50);
